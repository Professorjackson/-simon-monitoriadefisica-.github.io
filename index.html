<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMON - Sistema de Monitoria</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; color: #1a1a1a; }
        
        /* Auth Screens */
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #6366f1; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        h2 { text-align: center; margin-bottom: 22px; color: #4f46e5; }
        h3 { text-align: center; margin-bottom: 18px; color: #e16a3f; }
        h4 { text-align: center; margin-bottom: 17px; color: #8b9da5; }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        /* PIN Input */
        .pin-input-group { display: flex; gap: 10px; justify-content: center; }
        .pin-box { width: 45px; height: 45px; text-align: center; font-size: 18px; font-weight: bold; border: 2px solid #ddd; border-radius: 8px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: #6366f1; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.3s; }
        .btn:hover { background: #4f46e5; }
        .btn-sm { padding: 8px 12px; font-size: 12px; border-radius: 6px; border: none; color: white; cursor: pointer; }
        .btn-info { background: #3b82f6; }
        .btn-success { background: #10b981; }
        .btn-danger { background: #ef4444; }
        .btn-warning { background: #f59e0b; }
        .link-btn { background: none; color: #6366f1; border: none; width: 100%; margin-top: 15px; cursor: pointer; font-size: 13px; text-decoration: underline; }
        
        /* Main App Layout */
        #mainApp { display: none; min-height: 100vh; }
        .sidebar { width: 260px; background: #1e293b; color: white; padding: 20px; position: fixed; height: 100%; overflow-y: auto; }
        .content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: background 0.3s; }
        .nav-item:hover, .nav-item.active { background: #334155; }
        
        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Cards */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8fafc; font-weight: 600; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        /* Status Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .pending { background: #fef3c7; color: #92400e; }
        .done { background: #d1fae5; color: #065f46; }
        .in-progress { background: #dbeafe; color: #1e40af; }
        
        /* Urgency Tags */
        .urgency-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: white; }
        .urg-alta { background: #ef4444; }
        .urg-media { background: #f59e0b; }
        .urg-baixa { background: #10b981; }
        
        /* Level Tags */
        .level-tag { padding: 4px 10px; border-radius: 6px; color: white; font-size: 13px; font-weight: bold; }
        
        /* Medals */
        .medal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .medal-card { border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .medal-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .medal-card.locked { opacity: 0.4; }
        .medal-card.unlocked { border-color: #fbbf24; background: #fffbeb; }
        .medal-card.selected { border-color: #6366f1; background: #eef2ff; border-width: 2px; }
        
        /* Ranking */
        .ranking-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .ranking-table thead th { font-size: 12px; text-transform: uppercase; color: #64748b; text-align: left; }
        .ranking-table tbody tr { background: #f8fafc; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .ranking-table tbody td { padding: 14px; font-size: 13px; vertical-align: middle; }
        .rank-pos { font-weight: bold; text-align: center; color: #6366f1; }
        .rank-name { font-weight: 600; }
        .rank-points { display: flex; gap: 8px; flex-wrap: wrap; }
        .rank-badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; font-weight: bold; white-space: nowrap; }
        .badge-mes { background: #e0f2fe; color: #0369a1; }
        .badge-medalha { background: #fef3c7; color: #92400e; }
        .badge-total { background: #6366f1; color: white; }
        
        /* Admin Stats */
        .admin-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #6366f1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 10px; text-align: left; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #1e293b; }
        
        /* Progress Bar */
        .progress-container { margin-top: 20px; background: #e2e8f0; border-radius: 10px; height: 24px; position: relative; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); transition: width 0.5s ease; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 11px; font-weight: bold; line-height: 24px; color: #1e293b; }
        
        /* Activity Cards */
        .activity-card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; }
        .activity-late { color: #ef4444; font-weight: bold; font-size: 11px; margin-top: 5px; }
        
        /* Loading */
        .loading { text-align: center; padding: 20px; color: #64748b; }
        
        /* Error Messages */
        .error-message { color: #ef4444; font-size: 12px; text-align: center; margin-bottom: 10px; padding: 10px; background: #fee2e2; border-radius: 6px; }
        .success-message { color: #10b981; font-size: 12px; text-align: center; margin-bottom: 10px; padding: 10px; background: #d1fae5; border-radius: 6px; }
        
        /* Hidden */
        .hidden { display: none; }
        
        /* Rubrica Box */
        .rubrica-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        
        /* User Info Header */
        .user-header { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; gap: 15px; align-items: center; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: #6366f1; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-box">
            <div id="loadingIndicator" style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                <h3>Carregando Sistema...</h3>
                <p style="color: #64748b; font-size: 13px;">Aguarde enquanto conectamos ao servidor</p>
                <div style="margin-top: 20px;">
                    <div style="width: 100%; background: #e2e8f0; height: 4px; border-radius: 2px; overflow: hidden;">
                        <div id="loadingBar" style="width: 0%; height: 100%; background: #6366f1; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <div id="loginForm" style="display: none;">
                <h2>‚öõÔ∏è SIMON</h2>
                <h4>Sistema Integrado de Monitoria Online</h4>
                <h3>Entrar no Sistema</h3>
                             
                <div id="loginError" class="error-message hidden"></div>
                <div class="form-group">
                    <label>CPF (apenas n√∫meros)</label>
                    <input type="text" id="loginCPF" maxlength="11" placeholder="00000000000">
                </div>
                <div class="form-group">
                    <label>Senha (PIN de 4 d√≠gitos)</label>
                    <div class="pin-input-group" id="loginPinGroup">
                        <input class="pin-box" type="password" maxlength="1">
                        <input class="pin-box" type="password" maxlength="1">
                        <input class="pin-box" type="password" maxlength="1">
                        <input class="pin-box" type="password" maxlength="1">
                    </div>
                </div>
                <button class="btn" onclick="login()">Entrar</button>
                <button class="link-btn" onclick="showRegisterScreen()">Cadastrar novo monitor</button>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="auth-container hidden">
        <div class="auth-box">
            <h3>Cadastro de Monitor</h3>
            <div id="registerError" class="error-message hidden"></div>
            <div id="registerSuccess" class="success-message hidden"></div>
            
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="regNome" placeholder="Jo√£o Silva">
            </div>
            
            <div class="form-group">
                <label>CPF (apenas n√∫meros)</label>
                <input type="text" id="regCPF" maxlength="11" placeholder="12345678900">
            </div>
            
            <div class="form-group">
                <label>Celular</label>
                <input type="text" id="regCelular" placeholder="(81) 99999-9999">
            </div>
            
            <div class="form-group">
                <label>Data de Nascimento</label>
                <input type="date" id="regData">
            </div>
            
            <div class="form-group">
                <label>Turma</label>
                <select id="regTurma">
                    <option value="">Selecione...</option>
                    <option value="1A">1¬∞ Ano A</option>
                    <option value="1B">1¬∞ Ano B</option>
                    <option value="1C">1¬∞ Ano C</option>
                    <option value="2A">2¬∞ Ano A</option>
                    <option value="2B">2¬∞ Ano B</option>
                    <option value="2C">2¬∞ Ano C</option>
                    <option value="3A">3¬∞ Ano A</option>
                    <option value="3B">3¬∞ Ano B</option>
                    <option value="3C">3¬∞ Ano C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Criar PIN (4 d√≠gitos)</label>
                <div class="pin-input-group" id="regPinGroup">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                </div>
            </div>
            
            <button class="btn" onclick="register()">Cadastrar</button>
            <button class="link-btn" onclick="showLoginScreen()">Voltar ao Login</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2 style="margin-bottom: 30px;">‚öõÔ∏è SIMON</h2>
            
            <div id="userProfile" style="margin-bottom: 30px; padding: 15px; background: #334155; border-radius: 8px;">
                <div class="user-avatar" id="sidebarAvatar"></div>
                <div style="margin-top: 10px;">
                    <strong id="sidebarNome"></strong>
                    <div style="font-size: 12px; color: #94a3b8;" id="sidebarTurma"></div>
                </div>
            </div>
            
            <!-- Monitor Menu -->
            <div id="monitorMenu">
                <div class="nav-item" onclick="showScreen('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="showScreen('tarefas')">üìã Minhas Tarefas</div>
                <div class="nav-item" onclick="showScreen('avaliacoes')">‚≠ê Minhas Avalia√ß√µes</div>
                <div class="nav-item" onclick="showScreen('ranking')">üèÜ Ranking</div>
                <div class="nav-item" onclick="showScreen('perfil')">üë§ Meu Perfil</div>
            </div>
            
            <!-- Admin Menu -->
            <div id="adminMenu" class="hidden">
                <div class="nav-item" onclick="showScreen('adminDashboard')">üéØ Dashboard Admin</div>
                <div class="nav-item" onclick="showScreen('gerenciarMonitores')">üë• Gerenciar Monitores</div>
                <div class="nav-item" onclick="showScreen('gerenciarTarefas')">üìù Gerenciar Tarefas</div>
                <div class="nav-item" onclick="showScreen('avaliarMonitores')">‚≠ê Avaliar Monitores</div>
                <div class="nav-item" onclick="showScreen('ranking')">üèÜ Ranking</div>
                <div class="nav-item" onclick="showScreen('adminConfig')">‚öôÔ∏è Configura√ß√µes</div>
            </div>
            
            <div class="nav-item" onclick="logout()" style="margin-top: 20px; background: #ef4444;">üö™ Sair</div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Dashboard Monitor -->
            <div id="dashboard" class="screen">
                <!-- Banner Monitor Cientista -->
                <div id="cientistaBanner" style="display: none; background: linear-gradient(135deg, #fbbf24 0%, #10b981 100%); color: #1e293b; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 3px solid #047857; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b;">üéâ Parab√©ns! Voc√™ conquistou o selo Monitor Cientista ‚≠ê</h2>
                    <p style="margin: 10px 0; font-size: 14px; line-height: 1.6;">
                        Esse selo reconhece sua trajet√≥ria cient√≠fica completa:<br>
                        leitura, pesquisa, produ√ß√£o acad√™mica, participa√ß√£o em eventos,
                        mentorias e olimp√≠adas.
                    </p>
                    <p style="margin-top: 12px; font-size: 13px; font-style: italic;">
                        O selo Monitor Cientista representa seu hist√≥rico e suas conquistas acad√™micas
                        e n√£o depende das avalia√ß√µes mensais.
                    </p>
                    <b style="display: block; margin-top: 10px; font-size: 15px;">Continue evoluindo e inspirando outros monitores!</b>
                </div>

                <div class="user-header">
                    <div class="user-info">
                        <div class="user-avatar" id="dashAvatar"></div>
                        <div>
                            <h3 id="dashNome" style="margin: 0; text-align: left;"></h3>
                            <p id="dashTurma" style="margin: 0; color: #64748b; font-size: 13px;"></p>
                        </div>
                    </div>
                    <div>
                        <span class="level-tag" id="dashLevel" style="background: #6366f1;"></span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">üìä Resumo do M√™s</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #6366f1;" id="dashTarefasConcluidas">0</div>
                            <div style="font-size: 12px; color: #64748b;">Tarefas Conclu√≠das</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="dashTarefasPendentes">0</div>
                            <div style="font-size: 12px; color: #64748b;">Tarefas Pendentes</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="dashPontuacao">0</div>
                            <div style="font-size: 12px; color: #64748b;">Pontos Totais</div>
                            <div id="dashPontuacaoDetalhada"></div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #a855f7;" id="dashMedalhas">0</div>
                            <div style="font-size: 12px; color: #64748b;">Medalhas</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4 style="margin-bottom: 10px;">üèÖ Minhas Medalhas</h4>
                    <div id="userMedalsDash" class="medal-grid"></div>
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f59e0b;">
                        <p style="font-size: 13px; color: #1e293b; line-height: 1.5; margin-bottom: 10px;">
                            As medalhas comprovam sua evolu√ß√£o t√©cnica. Ao completar seu quadro de medalhas, voc√™ atinge o selo <b>Monitor Cientista</b> e desbloqueia:
                        </p>
                        <ul style="font-size: 12px; color: #78350f; padding-left: 20px; margin: 0; line-height: 1.8;">
                            <li>‚úÖ <b>Pontua√ß√£o Extra:</b> B√¥nus m√°ximo nas provas trimestrais de F√≠sica</li>
                            <li>‚úÖ <b>Prioridade Total:</b> Prefer√™ncia em temas de pesquisa, feiras e viagens</li>
                            <li>‚úÖ <b>Lideran√ßa:</b> Elegibilidade para concorrer √† <b>Presid√™ncia da Monitoria</b></li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h4 style="margin-bottom: 15px;">üéØ Benef√≠cios por N√≠vel</h4>

<div style="display: flex; align-items: center; justify-content: space-between; background: #ffffff; padding: 12px; border-radius: 8px; border-left: 4px solid #0fe04e;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="background: #0fe04e; color: white; width: 100px; text-align: center; padding: 4px; border-radius: 4px; font-size: 10px; font-weight: bold;">INICIANTE</div>
                <span style="font-size: 12px; color: #475569;">Fase de adapta√ß√£o e treinamento.</span>
            </div>
            <div style="text-align: right;">
                <span style="display: block; font-size: 14px; font-weight: bold; color: #1e293b;">+ 1,0</span>
                <span style="font-size: 9px; color: #94a3b8;">PONTO EXTRA</span>
            </div>
        </div>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; background: #ffffff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #3b82f6; color: white; min-width: 100px; text-align: center; padding: 4px; border-radius: 4px; font-size: 10px; font-weight: bold;">COLABORADOR</div>
                                <span style="font-size: 12px; color: #475569;">Participa√ß√£o ativa nas tarefas</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="display: block; font-size: 14px; font-weight: bold; color: #3b82f6;">+ 1.5</span>
                                <span style="font-size: 9px; color: #94a3b8;">PONTOS EXTRA</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: space-between; background: #ffffff; padding: 12px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #8b5cf6; color: white; min-width: 100px; text-align: center; padding: 4px; border-radius: 4px; font-size: 10px; font-weight: bold;">DESENVOLVEDOR</div>
                                <span style="font-size: 12px; color: #475569;">Foco em pesquisa e relat√≥rios</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="display: block; font-size: 14px; font-weight: bold; color: #8b5cf6;">+ 2.5</span>
                                <span style="font-size: 9px; color: #94a3b8;">PONTOS EXTRA</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: space-between; background: #ffffff; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #f59e0b; color: white; min-width: 100px; text-align: center; padding: 4px; border-radius: 4px; font-size: 10px; font-weight: bold;">MENTOR</div>
                                <span style="font-size: 12px; color: #475569;">Auxilia a equipe e ensina colegas</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="display: block; font-size: 14px; font-weight: bold; color: #d97706;">+ 3.5</span>
                                <span style="font-size: 9px; color: #94a3b8;">PONTOS EXTRA</span>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: space-between; background: #ffffff; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: #ef4444; color: white; min-width: 100px; text-align: center; padding: 4px; border-radius: 4px; font-size: 10px; font-weight: bold;">L√çDER</div>
                                <span style="font-size: 12px; color: #475569; font-weight: 500;">Gest√£o e lideran√ßa da equipe</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="display: block; font-size: 14px; font-weight: bold; color: #b91c1c;">+ 4.5</span>
                                <span style="font-size: 9px; color: #94a3b8;">PONTOS EXTRA</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarefas -->
            <div id="tarefas" class="screen">
                <h2 style="margin-bottom: 20px;">üìã Minhas Tarefas</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-sm btn-info" onclick="filterTarefas('todas')">Todas</button>
                    <button class="btn-sm btn-warning" onclick="filterTarefas('pendentes')">Pendentes</button>
                    <button class="btn-sm btn-success" onclick="filterTarefas('concluidas')">Conclu√≠das</button>
                </div>

                <div id="listaTarefas"></div>
            </div>

            <!-- Avalia√ß√µes -->
            <div id="avaliacoes" class="screen">
                <h2 style="margin-bottom: 20px;">‚≠ê Minhas Avalia√ß√µes</h2>
                <div id="listaAvaliacoes"></div>
            </div>

            <!-- Ranking -->
            <div id="ranking" class="screen">
                <h2 style="margin-bottom: 20px;">üèÜ Ranking Geral</h2>
                
                <div class="card">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Monitor</th>
                                <th>Turma</th>
                                <th>Pontua√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Perfil -->
            <div id="perfil" class="screen">
                <h2 style="margin-bottom: 20px;">üë§ Meu Perfil</h2>
                
                <div class="card">
                    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                        <div class="user-avatar" id="perfilAvatar" style="width: 80px; height: 80px; font-size: 32px;"></div>
                        <div>
                            <h3 id="perfilNome" style="margin: 0;"></h3>
                            <p id="perfilTurma" style="margin: 5px 0; color: #64748b;"></p>
                            <span class="level-tag" id="perfilLevel" style="background: #6366f1;"></span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong>CPF:</strong> <span id="perfilCPF"></span><br>
                        <strong>Celular:</strong> <span id="perfilCelular"></span><br>
                        <strong>Data de Nascimento:</strong> <span id="perfilData"></span>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4>üèÖ Minhas Medalhas</h4>
                        <div id="perfilMedalhas" class="medal-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="screen">
                <h2 style="margin-bottom: 20px;">üéØ Dashboard Administrativo</h2>
                
                <div class="admin-stats-grid">
                    <div class="stat-card">
                        <h3>Total de Monitores</h3>
                        <div class="value" id="adminTotalMonitores">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #10b981;">
                        <h3>Tarefas Ativas</h3>
                        <div class="value" id="adminTarefasAtivas">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #f59e0b;">
                        <h3>Tarefas Pendentes</h3>
                        <div class="value" id="adminTarefasPendentes">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #a855f7;">
                        <h3>Avalia√ß√µes Este M√™s</h3>
                        <div class="value" id="adminAvaliacoes">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="action-card" onclick="showScreen('gerenciarMonitores')">
                        <span style="font-size: 24px;">üë•</span>
                        <span>Gerenciar Monitores</span>
                    </div>
                    <div class="action-card" onclick="showScreen('gerenciarTarefas')">
                        <span style="font-size: 24px;">üìù</span>
                        <span>Gerenciar Tarefas</span>
                    </div>
                    <div class="action-card" onclick="showScreen('avaliarMonitores')">
                        <span style="font-size: 24px;">‚≠ê</span>
                        <span>Avaliar Monitores</span>
                    </div>
                    <div class="action-card" onclick="showScreen('adminConfig')">
                        <span style="font-size: 24px;">‚öôÔ∏è</span>
                        <span>Configura√ß√µes</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Atividade Recente</h3>
                    <div id="adminAtividadeRecente"></div>
                </div>
            </div>

            <!-- Gerenciar Monitores -->
            <div id="gerenciarMonitores" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üë• Gerenciar Monitores</h2>
                    <button class="btn-sm btn-success" onclick="openNovoMonitorModal()">‚ûï Novo Monitor</button>
                </div>
                
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Turma</th>
                                <th>Pontua√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaMonitores"></tbody>
                    </table>
                </div>
            </div>

            <!-- Gerenciar Tarefas -->
            <div id="gerenciarTarefas" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìù Gerenciar Tarefas</h2>
                    <button class="btn-sm btn-success" onclick="openNovaTarefaModal()">‚ûï Nova Tarefa</button>
                </div>
                
                <div class="card">
                    <div id="adminListaTarefas"></div>
                </div>
            </div>

            <!-- Avaliar Monitores -->
            <div id="avaliarMonitores" class="screen">
                <h2 style="margin-bottom: 20px;">‚≠ê Avaliar Monitores</h2>
                
                <div class="card">
                    <div class="form-group">
                        <label>Selecione o m√™s</label>
                        <input type="month" id="mesAvaliacao" onchange="carregarMonitoresParaAvaliar()">
                    </div>
                    
                    <div id="listaMonitoresAvaliar"></div>
                </div>
            </div>

            <!-- Configura√ß√µes Admin -->
            <div id="adminConfig" class="screen">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                
                <div class="card">
                    <h3>üë§ Gerenciar Administradores</h3>
                    <button class="btn-sm btn-success" onclick="openNovoAdminModal()" style="margin-bottom: 15px;">‚ûï Adicionar Admin</button>
                    <div id="listaAdmins"></div>
                </div>
<div class="card">
    <h3>üë• Gerenciar Administradores</h3>
    <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
        Gerencie os administradores do sistema
    </p>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Celular</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tabelaAdmins"></tbody>
    </table>
    <button class="btn-sm btn-success" onclick="openNovoAdminModal()" style="margin-top: 10px;">
        + Adicionar Administrador
    </button>
</div>
                <div class="card">
    <h3>üóëÔ∏è Limpeza de Dados</h3>
    <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
        Estas a√ß√µes s√£o irrevers√≠veis. Use com cuidado!
    </p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn-sm btn-warning" onclick="limparAvaliacoesPorMes()">
            üìÖ Limpar Avalia√ß√µes de 1 M√™s
        </button>
        <button class="btn-sm btn-warning" onclick="limparAvaliacoesAntigas()">
            üßπ Limpar Avalia√ß√µes Antigas
        </button>
        <button class="btn-sm btn-danger" onclick="limparTarefasConcluidas()">
            ‚úì Limpar Tarefas Conclu√≠das
        </button>
        <button class="btn-sm btn-danger" onclick="resetarAvaliacoesManterMedalhas()">
            üîÑ Resetar Avalia√ß√µes (manter medalhas)
        </button>
        <button class="btn-sm btn-danger" onclick="excluirTudoCompleto()">
            üö® APAGAR TUDO
        </button>
    </div>
</div>

                <div class="card">
                    <h3>üìä Exportar Dados</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-sm btn-info" onclick="exportarMonitores()">
                            üì• Exportar Monitores (EXCEL)
                        </button>
                        <button class="btn-sm btn-info" onclick="exportarTarefas()">
                            üì• Exportar Tarefas (EXCEL)
                        </button>
                        <button class="btn-sm btn-info" onclick="exportarAvaliacoes()">
                            üì• Exportar Avalia√ß√µes (EXCEL)
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal: Novo Admin -->
<div id="adminModal" class="modal">
    <div class="modal-content">
        <h3 id="adminModalTitulo">Adicionar Administrador</h3>
        <div id="adminModalError" class="error-message hidden"></div>
        
        <input type="hidden" id="adminId">
        
        <div class="form-group">
            <label>Nome Completo</label>
            <input type="text" id="adminNome">
        </div>
        
        <div class="form-group">
            <label>CPF</label>
            <input type="text" id="adminCPF" maxlength="11">
        </div>
        
        <div class="form-group">
            <label>Celular</label>
            <input type="text" id="adminCelular">
        </div>
        
        <div class="form-group">
            <label>PIN (4 d√≠gitos) - Deixe em branco para manter o atual</label>
            <div class="pin-input-group" id="adminPinGroup">
                <input class="pin-box" type="password" maxlength="1">
                <input class="pin-box" type="password" maxlength="1">
                <input class="pin-box" type="password" maxlength="1">
                <input class="pin-box" type="password" maxlength="1">
            </div>
            <small style="color: #64748b; font-size: 11px; display: block; margin-top: 5px;">
                üí° Dica: Ao editar, s√≥ preencha o PIN se quiser alter√°-lo
            </small>
        </div>
        
        <button class="btn btn-success" onclick="salvarAdmin()">Salvar</button>
        <button class="link-btn" onclick="fecharAdminModal()">Cancelar</button>
    </div>
</div>

    <!-- Modal: Novo/Editar Monitor -->
    <div id="monitorModal" class="modal">
        <div class="modal-content">
            <h3 id="monitorModalTitulo">Novo Monitor</h3>
            <div id="monitorModalError" class="error-message hidden"></div>
            
            <input type="hidden" id="monitorId">
            
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="monitorNome">
            </div>
            
            <div class="form-group">
                <label>CPF</label>
                <input type="text" id="monitorCPF" maxlength="11">
            </div>
            
            <div class="form-group">
                <label>Celular</label>
                <input type="text" id="monitorCelular">
            </div>
            
            <div class="form-group">
                <label>Data de Nascimento</label>
                <input type="date" id="monitorData">
            </div>
            
            <div class="form-group">
                <label>Turma</label>
                <select id="monitorTurma">
                    <option value="">Selecione...</option>
                    <option value="1A">1¬∞ Ano A</option>
                    <option value="1B">1¬∞ Ano B</option>
                    <option value="1C">1¬∞ Ano C</option>
                    <option value="2A">2¬∞ Ano A</option>
                    <option value="2B">2¬∞ Ano B</option>
                    <option value="2C">2¬∞ Ano C</option>
                    <option value="3A">3¬∞ Ano A</option>
                    <option value="3B">3¬∞ Ano B</option>
                    <option value="3C">3¬∞ Ano C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>PIN (4 d√≠gitos)</label>
                <div class="pin-input-group" id="monitorPinGroup">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                    <input class="pin-box" type="password" maxlength="1">
                </div>
            </div>
            
            <button class="btn btn-success" onclick="salvarMonitor()">Salvar</button>
            <button class="link-btn" onclick="fecharMonitorModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Nova/Editar Tarefa -->
    <div id="tarefaModal" class="modal">
        <div class="modal-content">
            <h3 id="tarefaModalTitulo">Nova Tarefa</h3>
            <div id="tarefaModalError" class="error-message hidden"></div>
            
            <input type="hidden" id="tarefaId">
            
            <div class="form-group">
                <label>T√≠tulo</label>
                <input type="text" id="tarefaTitulo">
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="tarefaDescricao"></textarea>
            </div>
            
            <div class="form-group">
                <label>Prazo</label>
                <input type="date" id="tarefaPrazo">
            </div>
            
            <div class="form-group">
                <label>Urg√™ncia</label>
                <select id="tarefaUrgencia">
                    <option value="Baixa">Baixa</option>
                    <option value="M√©dia">M√©dia</option>
                    <option value="Alta">Alta</option>
                </select>
            </div>
            
            <div class="form-group">
              <label>Monitores Respons√°veis</label>
              <div id="tarefaMonitores" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;"></div>
            </div>
            
            <button class="btn btn-success" onclick="salvarTarefa()">Salvar</button>
            <button class="link-btn" onclick="fecharTarefaModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Avalia√ß√£o -->
    <div id="avaliacaoModal" class="modal">
        <div class="modal-content">
            <h3>‚≠ê Avaliar Monitor</h3>
            <div id="avaliacaoModalError" class="error-message hidden"></div>
            
            <input type="hidden" id="avaliacaoMonitorId">
            <input type="hidden" id="avaliacaoMes">
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <strong id="avaliacaoNome"></strong>
                <div style="font-size: 12px; color: #64748b;" id="avaliacaoTurma"></div>
            </div>
            
            <div class="rubrica-box">
                <h4>Rubricas (0-2 pontos cada)</h4>
                
                <div class="form-group">
                    <label>Responsabilidade</label>
                    <select id="rubricaResponsabilidade">
                        <option value="0">0 - Insuficiente</option>
                        <option value="1">1 - Regular</option>
                        <option value="2" selected>2 - Excelente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Trabalho Coletivo</label>
                    <select id="rubricaTrabalhoColetivo">
                        <option value="0">0 - Insuficiente</option>
                        <option value="1">1 - Regular</option>
                        <option value="2" selected>2 - Excelente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Iniciativa</label>
                    <select id="rubricaIniciativa">
                        <option value="0">0 - Insuficiente</option>
                        <option value="1">1 - Regular</option>
                        <option value="2" selected>2 - Excelente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Comunica√ß√£o</label>
                    <select id="rubricaComunicacao">
                        <option value="0">0 - Insuficiente</option>
                        <option value="1">1 - Regular</option>
                        <option value="2" selected>2 - Excelente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Projetos</label>
                    <select id="rubricaProjetos">
                        <option value="0">0 - Insuficiente</option>
                        <option value="1">1 - Regular</option>
                        <option value="2" selected>2 - Excelente</option>
                    </select>
                </div>
            </div>
            
            <h4>üèÖ Medalhas Conquistadas</h4>
            <p style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                Cada medalha vale <strong>+5 pontos</strong> permanentes
            </p>
            <div id="medalhasAvaliacao" class="medal-grid"></div>
            
            <button class="btn btn-success" onclick="salvarAvaliacao()">Salvar Avalia√ß√£o</button>
            <button class="link-btn" onclick="fecharAvaliacaoModal()">Cancelar</button>
        </div>
    </div>

    <!-- Firebase SDK - Carregar antes do script principal -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
 
    <script>
        // ==================== FIREBASE CONFIG ====================
        // Aguardar carregamento completo do Firebase
        let db;
        
        function initFirebase() {
            try {
                console.log('üîß Inicializando Firebase...');
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAaomgw31u5y3yoTZ_Iy356R1Hzm3ltgZ8",
                    authDomain: "simon-monitoriadefisica.firebaseapp.com",
                    projectId: "simon-monitoriadefisica",
                    storageBucket: "simon-monitoriadefisica.firebasestorage.app",
                    messagingSenderId: "659521399804",
                    appId: "1:659521399804:web:abd6fdd50442ecc130a079"
                };

                // Inicializar Firebase apenas se ainda n√£o foi inicializado
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('‚úÖ Firebase app inicializado');
                } else {
                    console.log('‚ÑπÔ∏è Firebase app j√° estava inicializado');
                }
                
                // Inicializar Firestore
                db = firebase.firestore();
                console.log('‚úÖ Firestore inicializado');
                
                // Testar se db est√° funcionando
                if (!db || !db.collection) {
                    throw new Error('Firestore n√£o inicializou corretamente');
                }
                
                console.log('‚úÖ Firebase totalmente inicializado e funcional!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                throw error;
            }
        }

        // ==================== ESTADO GLOBAL ====================
        let currentUser = null;
        let monitores = [];
        let tarefas = [];
        let avaliacoes = [];
        let currentTarefaFilter = 'todas';

        // Lista de medalhas dispon√≠veis
        const MEDALHAS = [
            { 
                id: 'leitura', 
                icon: 'üìö', 
                nome: 'Leitura Cient√≠fica', 
                descricao: 'Leitura de 3 livros definidos pelo programa, com valida√ß√£o do coordenador',
                pontos: 5
            },
            { 
                id: 'pesquisa', 
                icon: 'üî¨', 
                nome: 'Pesquisa Cient√≠fica', 
                descricao: 'Participa√ß√£o em grupo de pesquisa + produ√ß√£o de 1 artigo ou relat√≥rio cient√≠fico',
                pontos: 5
            },
            { 
                id: 'tecnica', 
                icon: 'üéì', 
                nome: 'Forma√ß√£o T√©cnica', 
                descricao: 'Conclus√£o de 1 curso indicado pelo coordenador',
                pontos: 5
            },
            { 
                id: 'vivencia', 
                icon: 'üè≠', 
                nome: 'Viv√™ncia Cient√≠fica', 
                descricao: 'Participa√ß√£o em 2 visitas t√©cnicas, com relato reflexivo',
                pontos: 5
            },
            { 
                id: 'mentor', 
                icon: 'üé§', 
                nome: 'Mentorias em F√≠sica', 
                descricao: 'Participa√ß√£o em 3 mentorias, oficinas ou apresenta√ß√µes de F√≠sica',
                pontos: 5
            },
            { 
                id: 'olimp', 
                icon: 'üèÖ', 
                nome: 'Olimp√≠adas Cient√≠ficas', 
                descricao: 'Participa√ß√£o com medalha ou men√ß√£o honrosa',
                pontos: 5
            },
            { 
                id: 'mostra', 
                icon: 'üåü', 
                nome: 'Mostras Cient√≠ficas', 
                descricao: 'Participa√ß√£o em 2 mostras cient√≠ficas escolares ou externas',
                pontos: 5
            }
        ];

        // N√≠veis e benef√≠cios (baseados na pontua√ß√£o TOTAL)
        const NIVEIS = [
            { 
                nome: 'Iniciante', 
                minPontos: 0, 
                cor: '#94a3b8',
                bonus: '0',
                descricao: 'Bem-vindo √† monitoria!'
            },
            { 
                nome: 'Colaborador', 
                minPontos: 10, 
                cor: '#3b82f6',
                bonus: '1.5',
                descricao: 'Participa√ß√£o ativa nas tarefas'
            },
            { 
                nome: 'Desenvolvedor', 
                minPontos: 20, 
                cor: '#8b5cf6',
                bonus: '2.5',
                descricao: 'Foco em pesquisa e relat√≥rios'
            },
            { 
                nome: 'Mentor', 
                minPontos: 30, 
                cor: '#f59e0b',
                bonus: '3.5',
                descricao: 'Auxilia a equipe e ensina colegas'
            },
            { 
                nome: 'L√≠der', 
                minPontos: 40, 
                cor: '#ef4444',
                bonus: '4.5',
                descricao: 'Gest√£o e lideran√ßa da equipe'
            }
        ];

        // Mensagens de feedback por rubrica
        const FEEDBACK_RUBRICAS = {
            "Responsabilidade": {
                desc: "Avalia o cumprimento de prazos e compromissos assumidos.",
                frases: [
                    "‚ùå Neste m√™s, houve dificuldades no cumprimento de prazos ou compromissos.",
                    "‚ö†Ô∏è Voc√™ cumpriu parte das tarefas, mas ainda precisa melhorar sua organiza√ß√£o.",
                    "‚úÖ Excelente! Voc√™ cumpriu todos os compromissos com responsabilidade."
                ]
            },
            "TrabalhoColetivo": {
                desc: "Avalia a colabora√ß√£o e conviv√™ncia com o grupo.",
                frases: [
                    "‚ùå Houve dificuldades na colabora√ß√£o com o grupo.",
                    "‚ö†Ô∏è Voc√™ colaborou quando solicitado, mas pode se envolver mais.",
                    "‚úÖ √ìtima colabora√ß√£o! Sua postura contribuiu positivamente para o grupo."
                ]
            },
            "Iniciativa": {
                desc: "Avalia a√ß√µes realizadas al√©m do que foi solicitado.",
                frases: [
                    "‚ùå N√£o foram observadas iniciativas al√©m das tarefas propostas.",
                    "‚ö†Ô∏è Voc√™ demonstrou iniciativa pontual. Continue se arriscando mais.",
                    "‚úÖ Excelente iniciativa! Voc√™ prop√¥s e executou a√ß√µes de forma aut√¥noma."
                ]
            },
            "Comunicacao": {
                desc: "Avalia a clareza ao explicar conceitos de F√≠sica.",
                frases: [
                    "‚ùå Houve dificuldade em comunicar conceitos cient√≠ficos.",
                    "‚ö†Ô∏è Explica√ß√£o com apoio. Continue praticando.",
                    "‚úÖ Comunica√ß√£o clara e segura. √ìtima explica√ß√£o."
                ]
            },
            "Projetos": {
                desc: "Avalia o envolvimento em projetos, clubes ou atividades cient√≠ficas.",
                frases: [
                    "‚ùå N√£o houve participa√ß√£o em projetos ou clubes neste m√™s.",
                    "‚ö†Ô∏è Participa√ß√£o pontual. Busque maior continuidade.",
                    "‚úÖ Participa√ß√£o ativa e constante em projetos e clubes."
                ]
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function setupPinInputs(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn('Container PIN n√£o encontrado:', containerId);
                return;
            }
            
            const inputs = container.querySelectorAll('.pin-box');
            if (inputs.length === 0) {
                console.warn('Nenhum input PIN encontrado em:', containerId);
                return;
            }
            
            console.log('Configurando', inputs.length, 'inputs PIN em', containerId);
            
            inputs.forEach((input, index) => {
                // Limpar eventos anteriores
                input.replaceWith(input.cloneNode(true));
            });
            
            // Reobter inputs ap√≥s clone
            const newInputs = container.querySelectorAll('.pin-box');
            
            newInputs.forEach((input, index) => {
                // Evento de digita√ß√£o
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    
                    // Permitir apenas n√∫meros
                    if (value && !/^\d$/.test(value)) {
                        e.target.value = '';
                        return;
                    }
                    
                    // Mover para pr√≥ximo input se tiver valor
                    if (value && index < newInputs.length - 1) {
                        newInputs[index + 1].focus();
                        newInputs[index + 1].select();
                    }
                });
                
                // Evento de tecla pressionada
                input.addEventListener('keydown', (e) => {
                    // Backspace no campo vazio vai para anterior
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        e.preventDefault();
                        newInputs[index - 1].focus();
                        newInputs[index - 1].select();
                    }
                    
                    // Setas de navega√ß√£o
                    if (e.key === 'ArrowLeft' && index > 0) {
                        e.preventDefault();
                        newInputs[index - 1].focus();
                        newInputs[index - 1].select();
                    }
                    
                    if (e.key === 'ArrowRight' && index < newInputs.length - 1) {
                        e.preventDefault();
                        newInputs[index + 1].focus();
                        newInputs[index + 1].select();
                    }
                });
                
                // Colar c√≥digo completo
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text');
                    const digits = paste.replace(/\D/g, '').split('');
                    
                    digits.forEach((digit, i) => {
                        if (index + i < newInputs.length) {
                            newInputs[index + i].value = digit;
                        }
                    });
                    
                    // Focar no pr√≥ximo campo vazio ou √∫ltimo
                    const nextEmpty = Array.from(newInputs).findIndex((inp, i) => i > index && !inp.value);
                    if (nextEmpty !== -1) {
                        newInputs[nextEmpty].focus();
                    } else {
                        newInputs[newInputs.length - 1].focus();
                    }
                });
                
                // Selecionar ao focar
                input.addEventListener('focus', (e) => {
                    e.target.select();
                });
            });
            
            console.log('‚úÖ Inputs PIN configurados em', containerId);
        }

        function getPinValue(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.pin-box');
            return Array.from(inputs).map(input => input.value).join('');
        }

        function clearPinInputs(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.pin-box');
            inputs.forEach(input => input.value = '');
            inputs[0].focus();
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function formatCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function getInitials(name) {
            const parts = name.split(' ');
            return parts[0][0] + (parts.length > 1 ? parts[parts.length - 1][0] : '');
        }

        function calcularNivel(pontos) {
            if (pontos >= 40) return 'L√≠der';
            if (pontos >= 30) return 'Mentor';
            if (pontos >= 20) return 'Desenvolvedor';
            if (pontos >= 10) return 'Colaborador';
            return 'Iniciante';
        }

        function getNivelInfo(pontos) {
            for (let i = NIVEIS.length - 1; i >= 0; i--) {
                if (pontos >= NIVEIS[i].minPontos) {
                    return NIVEIS[i];
                }
            }
            return NIVEIS[0];
        }

        function calcularPontuacaoTotal(monitor) {
            // Pontos da avalia√ß√£o do m√™s atual (0-10 pontos)
            const mesAtual = new Date().toISOString().substr(0, 7);
            const avaliacaoMesAtual = avaliacoes.find(a => 
                a.monitorId === monitor.id && a.mes === mesAtual
            );
            const pontosAvaliacaoMes = avaliacaoMesAtual ? (avaliacaoMesAtual.pontuacao || 0) : 0;
            
            // Pontos das medalhas (5 pontos cada, m√°ximo 35)
            const pontosMedalhas = (monitor.medalhas || []).length * 5;
            
            return {
                avaliacao: pontosAvaliacaoMes,
                medalhas: pontosMedalhas,
                total: pontosAvaliacaoMes + pontosMedalhas
            };
        }

        function isMonitorCientista(monitor) {
            return (monitor.medalhas || []).length === 7;
        }

        function getUrgenciaClass(urgencia) {
            if (urgencia === 'Alta') return 'urg-alta';
            if (urgencia === 'M√©dia') return 'urg-media';
            return 'urg-baixa';
        }

        function getStatusClass(status) {
            if (status === 'Conclu√≠da') return 'done';
            if (status === 'Em Andamento') return 'in-progress';
            return 'pending';
        }

        // ==================== FIREBASE OPERATIONS ====================
        async function carregarMonitores() {
            try {
                console.log('üîÑ Carregando monitores do Firebase...');
                const snapshot = await db.collection('monitores').get();
                monitores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('‚úÖ Monitores carregados:', monitores.length);
                monitores.forEach(m => console.log('  -', m.nome, '(' + m.tipo + ')'));
            } catch (error) {
                console.error('‚ùå Erro ao carregar monitores:', error);
                alert('Erro ao carregar monitores. Verifique o console.');
            }
        }

        async function carregarTarefas() {
            try {
                console.log('üîÑ Carregando tarefas do Firebase...');
                const snapshot = await db.collection('tarefas').get();
                tarefas = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('‚úÖ Tarefas carregadas:', tarefas.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar tarefas:', error);
                alert('Erro ao carregar tarefas. Verifique o console.');
            }
        }

        async function carregarAvaliacoes() {
            try {
                console.log('üîÑ Carregando avalia√ß√µes do Firebase...');
                const snapshot = await db.collection('avaliacoes').get();
                avaliacoes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('‚úÖ Avalia√ß√µes carregadas:', avaliacoes.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar avalia√ß√µes:', error);
                alert('Erro ao carregar avalia√ß√µes. Verifique o console.');
            }
        }

        async function verificarConexaoFirebase() {
            try {
                console.log('üîç Verificando conex√£o com Firebase...');
                const testDoc = await db.collection('_test').doc('conexao').set({
                    teste: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Conex√£o com Firebase OK!');
                await db.collection('_test').doc('conexao').delete();
                return true;
            } catch (error) {
                console.error('‚ùå Erro na conex√£o com Firebase:', error);
                alert('Erro ao conectar com Firebase:\n' + error.message);
                return false;
            }
        }

        async function carregarTodosDados() {
            await Promise.all([
                carregarMonitores(),
                carregarTarefas(),
                carregarAvaliacoes()
            ]);
        }

        // ==================== AUTH FUNCTIONS ====================
        async function login() {
            const cpf = document.getElementById('loginCPF').value.trim();
            const pin = getPinValue('loginPinGroup');

            console.log('üîê Tentativa de login:', { cpf: cpf ? 'fornecido' : 'vazio', pin: pin.length + ' d√≠gitos' });

            if (!cpf || !pin || pin.length !== 4) {
                showError('loginError', 'Preencha CPF e PIN corretamente (4 d√≠gitos)');
                return;
            }

            if (!db) {
                showError('loginError', 'Sistema n√£o inicializado. Recarregue a p√°gina.');
                console.error('‚ùå Firebase db n√£o est√° inicializado');
                return;
            }

            try {
                console.log('üîç Buscando usu√°rio no Firebase...');
                const snapshot = await db.collection('monitores')
                    .where('cpf', '==', cpf)
                    .get();

                if (snapshot.empty) {
                    console.log('‚ùå CPF n√£o encontrado');
                    showError('loginError', 'CPF n√£o encontrado no sistema');
                    return;
                }

                const userData = snapshot.docs[0].data();
                console.log('‚úÖ Usu√°rio encontrado:', userData.nome);

                if (userData.pin !== pin) {
                    console.log('‚ùå PIN incorreto');
                    showError('loginError', 'PIN incorreto');
                    clearPinInputs('loginPinGroup');
                    return;
                }

                currentUser = {
                    id: snapshot.docs[0].id,
                    ...userData
                };

                console.log('‚úÖ Login bem-sucedido:', currentUser.nome, '(' + currentUser.tipo + ')');
                sessionStorage.setItem('userId', currentUser.id);
                await startApp();
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                showError('loginError', 'Erro ao fazer login: ' + error.message);
            }
        }

        async function register() {
            const nome = document.getElementById('regNome').value.trim();
            const cpf = document.getElementById('regCPF').value.trim();
            const celular = document.getElementById('regCelular').value.trim();
            const dataNascimento = document.getElementById('regData').value;
            const turma = document.getElementById('regTurma').value;
            const pin = getPinValue('regPinGroup');

            if (!nome || !cpf || !celular || !dataNascimento || !turma || pin.length !== 4) {
                showError('registerError', 'Preencha todos os campos');
                return;
            }

            if (cpf.length !== 11) {
                showError('registerError', 'CPF deve ter 11 d√≠gitos');
                return;
            }

            try {
                // Verificar se CPF j√° existe
                const snapshot = await db.collection('monitores')
                    .where('cpf', '==', cpf)
                    .get();

                if (!snapshot.empty) {
                    showError('registerError', 'CPF j√° cadastrado');
                    return;
                }

                // Criar monitor
                const novoMonitor = {
                    nome,
                    cpf,
                    celular,
                    dataNascimento,
                    turma,
                    pin,
                    tipo: 'monitor',
                    pontuacao: 0,
                    medalhas: [],
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('monitores').add(novoMonitor);
                
                showSuccess('registerSuccess', 'Cadastro realizado com sucesso!');
                
                // Limpar form
                document.getElementById('regNome').value = '';
                document.getElementById('regCPF').value = '';
                document.getElementById('regCelular').value = '';
                document.getElementById('regData').value = '';
                document.getElementById('regTurma').value = '';
                clearPinInputs('regPinGroup');

                setTimeout(() => showLoginScreen(), 2000);
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showError('registerError', 'Erro ao cadastrar');
            }
        }

        function logout() {
            sessionStorage.removeItem('userId');
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            clearPinInputs('loginPinGroup');
        }

        function showRegisterScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        // ==================== APP INITIALIZATION ====================
async function startApp() {
    // 1. Prepara a interface
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('registerScreen').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'block';

    // 2. Aguarda carregar todos os dados do Firebase
    await carregarTodosDados();

    // 3. SINCRONIZA√á√ÉO COMPLETA:
    // Procuramos o seu usu√°rio dentro da lista atualizada que veio do banco
    if (currentUser) {
        const dadosDoBanco = monitores.find(m => m.id === currentUser.id);
        if (dadosDoBanco) {
            // Isso garante que os pontos e o n√≠vel (Colaborador) sejam os mesmos em todo o app
            currentUser = { ...currentUser, ...dadosDoBanco };
        }
    }

    // 4. CORRE√á√ÉO DE ERRO: Garante que o ranking n√£o trave o carregamento dos Administradores
    if (typeof monitores !== 'undefined') {
        window.topMonitores = [...monitores].sort((a, b) => (b.pontuacao || 0) - (a.pontuacao || 0)).slice(0, 5);
    }

    // 5. Agora atualiza a interface com os dados j√° sincronizados
    atualizarInterface();
    
    // 6. Direciona para a tela correta
    if (currentUser.tipo === 'admin') {
        showScreen('adminDashboard');
    } else {
        showScreen('dashboard');
    }
}

        function atualizarInterface() {
            // Atualizar sidebar
            document.getElementById('sidebarAvatar').textContent = getInitials(currentUser.nome);
            document.getElementById('sidebarNome').textContent = currentUser.nome;
            document.getElementById('sidebarTurma').textContent = currentUser.turma || 'Administrador';

            // Mostrar menu apropriado
            if (currentUser.tipo === 'admin') {
                document.getElementById('monitorMenu').classList.add('hidden');
                document.getElementById('adminMenu').classList.remove('hidden');
            } else {
                document.getElementById('monitorMenu').classList.remove('hidden');
                document.getElementById('adminMenu').classList.add('hidden');
            }

            // Atualizar todas as telas
            if (currentUser.tipo !== 'admin') {
                atualizarDashboard();
                atualizarTarefas();
                atualizarAvaliacoes();
                atualizarPerfil();
            }
            
            atualizarRanking();

            if (currentUser.tipo === 'admin') {
                atualizarAdminDashboard();
                atualizarGerenciarMonitores();
                atualizarGerenciarTarefas();
                atualizarConfigAdmin();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(screenId).classList.add('active');
            
            // Atualizar nav ativo
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(screenId.toLowerCase())) {
                    item.classList.add('active');
                }
            });
        }

        // ==================== DASHBOARD ====================
        function atualizarDashboard() {
            const minhasTarefas = tarefas.filter(t => t.monitorId === currentUser.id);
            const tarefasConcluidas = minhasTarefas.filter(t => t.status === 'Conclu√≠da').length;
            const tarefasPendentes = minhasTarefas.filter(t => t.status !== 'Conclu√≠da').length;
            
            // Calcular pontua√ß√µes separadas
            const pontuacao = calcularPontuacaoTotal(currentUser);
            const nivelInfo = getNivelInfo(pontuacao.total);
            const ehCientista = isMonitorCientista(currentUser);
            
            document.getElementById('dashAvatar').textContent = getInitials(currentUser.nome);
            document.getElementById('dashNome').textContent = currentUser.nome;
            document.getElementById('dashTurma').textContent = currentUser.turma;
            document.getElementById('dashLevel').textContent = nivelInfo.nome;
            document.getElementById('dashLevel').style.background = nivelInfo.cor;
            document.getElementById('dashTarefasConcluidas').textContent = tarefasConcluidas;
            document.getElementById('dashTarefasPendentes').textContent = tarefasPendentes;
            document.getElementById('dashPontuacao').textContent = pontuacao.total;
            document.getElementById('dashMedalhas').textContent = (currentUser.medalhas || []).length + '/7';

            // Mostrar pontua√ß√£o detalhada
            document.getElementById('dashPontuacaoDetalhada').innerHTML = `
                <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                    Avalia√ß√£o: <strong>${pontuacao.avaliacao}/10</strong> |
                    Medalhas: <strong>${pontuacao.medalhas}/35</strong>
                </div>
            `;

            // Banner de Monitor Cientista
            const bannerCientista = document.getElementById('cientistaBanner');
            if (ehCientista) {
                bannerCientista.style.display = 'block';
            } else {
                bannerCientista.style.display = 'none';
            }

            // Mostrar medalhas no dashboard
            const medalhasHtml = MEDALHAS.map(medalha => {
                const conquistada = (currentUser.medalhas || []).includes(medalha.id);
                return `
                    <div class="medal-card ${conquistada ? 'unlocked' : 'locked'}">
                        <div style="font-size: 32px;">${medalha.icon}</div>
                        <div style="font-size: 11px; font-weight: bold; margin-top: 5px;">${medalha.nome}</div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 3px;">${medalha.descricao}</div>
                        ${conquistada ? '<div style="margin-top: 5px; color: #10b981; font-weight: bold; font-size: 11px;">‚úì +5 pts</div>' : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('userMedalsDash').innerHTML = medalhasHtml;
        }

        // ==================== TAREFAS ====================
function atualizarTarefas() {
    // Filtrar tarefas onde o monitor atual est√° inclu√≠do
    const minhasTarefas = tarefas.filter(t => {
        if (Array.isArray(t.monitoresIds)) {
            return t.monitoresIds.includes(currentUser.id);
        }
        return t.monitorId === currentUser.id;
    });
    
    let tarefasFiltradas = minhasTarefas;

    if (currentTarefaFilter === 'pendentes') {
        tarefasFiltradas = minhasTarefas.filter(t => t.status !== 'Conclu√≠da');
    } else if (currentTarefaFilter === 'concluidas') {
        tarefasFiltradas = minhasTarefas.filter(t => t.status === 'Conclu√≠da');
    }

    const html = tarefasFiltradas.length > 0
        ? tarefasFiltradas.map(t => `
            <div class="activity-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>${t.titulo}</strong>
                    <div style="display: flex; gap: 5px;">
                        <span class="urgency-tag ${getUrgenciaClass(t.urgencia)}">${t.urgencia}</span>
                        <span class="status-badge ${getStatusClass(t.status)}">${t.status}</span>
                    </div>
                </div>
                <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">${t.descricao}</p>
                <div style="font-size: 12px; color: #64748b;">
                    üìÖ Prazo: ${formatDate(t.prazo)}
                </div>
                ${t.status !== 'Conclu√≠da' ? `
                    <button class="btn-sm btn-success" onclick="concluirTarefa('${t.id}')" style="margin-top: 10px;">
                        ‚úì Marcar como Conclu√≠da
                    </button>
                ` : ''}
            </div>
        `).join('')
        : '<p style="color: #64748b; text-align: center; padding: 20px;">Nenhuma tarefa encontrada</p>';

    document.getElementById('listaTarefas').innerHTML = html;
}
        function filterTarefas(filtro) {
            currentTarefaFilter = filtro;
            atualizarTarefas();
        }

async function concluirTarefa(tarefaId) {
    try {
        await db.collection('tarefas').doc(tarefaId).update({
            status: 'Conclu√≠da'
        });

        await carregarTarefas();
        atualizarTarefas();
        atualizarDashboard();
        alert('Tarefa conclu√≠da! ‚úÖ');
    } catch (error) {
        console.error('Erro ao concluir tarefa:', error);
        alert('Erro ao concluir tarefa');
    }
}

        // ==================== AVALIA√á√ïES ====================
function atualizarAvaliacoes() {
    const minhasAvaliacoes = avaliacoes.filter(a => a.monitorId === currentUser.id);

    const html = minhasAvaliacoes.length > 0
        ? minhasAvaliacoes.map(a => {
            const total = (a.rubricas?.Responsabilidade || 0) +
                        (a.rubricas?.TrabalhoColetivo || 0) +
                        (a.rubricas?.Iniciativa || 0) +
                        (a.rubricas?.Comunicacao || 0) +
                        (a.rubricas?.Projetos || 0);
            
            return `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">üìÖ ${a.mes}</h4>
                        <span style="font-size: 20px; font-weight: bold; color: #6366f1;">${total}/10</span>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        ${Object.keys(a.rubricas || {}).map(rubrica => {
                            const pontos = a.rubricas[rubrica] || 0;
                            const feedbackInfo = FEEDBACK_RUBRICAS[rubrica];
                            if (!feedbackInfo) return '';
                            
                            const feedback = feedbackInfo.frases[pontos];
                            const corBorda = pontos === 2 ? '#10b981' : pontos === 1 ? '#f59e0b' : '#ef4444';
                            
                            return `
                                <div style="border-left: 4px solid ${corBorda}; padding: 12px; background: #f8fafc; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <strong style="font-size: 13px;">${rubrica.replace(/([A-Z])/g, ' $1').trim()}</strong>
                                        <span style="font-weight: bold; color: ${corBorda};">${pontos}/2</span>
                                    </div>
                                    <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">
                                        ${feedbackInfo.desc}
                                    </div>
                                    <div style="font-size: 12px; color: #1e293b; padding: 8px; background: white; border-radius: 4px;">
                                        ${feedback}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${(a.medalhas || []).length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <strong>üèÖ Medalhas Conquistadas neste m√™s:</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px;">
                                ${a.medalhas.map(m => {
                                    const medalha = MEDALHAS.find(med => med.id === m);
                                    return medalha ? `
                                        <span style="background: #fef3c7; padding: 6px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px;">
                                            ${medalha.icon} ${medalha.nome}
                                        </span>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('')
        : '<p class="card" style="color: #64748b; text-align: center;">Voc√™ ainda n√£o possui avalia√ß√µes</p>';

    document.getElementById('listaAvaliacoes').innerHTML = html;
}

// ==================== RANKING ====================
function atualizarRanking() {
    const rankingData = monitores
        .filter(m => m.tipo !== 'admin')
        .map(m => ({
            ...m,
            pontuacaoTotal: calcularPontuacaoTotal(m).total
        }))
        .sort((a, b) => b.pontuacaoTotal - a.pontuacaoTotal)
        .map((m, index) => ({
            posicao: index + 1,
            ...m
        }));

    if (currentUser.tipo === 'admin') {
        // ADMIN: V√™ ranking completo
        const html = rankingData.map(m => {
            const nivelInfo = getNivelInfo(m.pontuacaoTotal);
            const pontuacao = calcularPontuacaoTotal(m);
            return `
                <tr>
                    <td class="rank-pos">${m.posicao}¬∞</td>
                    <td class="rank-name">
                        ${m.nome}
                        <div style="font-size: 10px; color: ${nivelInfo.cor}; font-weight: bold; margin-top: 2px;">
                            ${nivelInfo.nome}
                        </div>
                    </td>
                    <td>${m.turma}</td>
                    <td>
                        <div class="rank-points">
                            <span class="rank-badge badge-total">${pontuacao.total} pts</span>
                            <span class="rank-badge badge-mes">Aval: ${pontuacao.avaliacao}</span>
                            <span class="rank-badge badge-medalha">${(m.medalhas || []).length} üèÖ</span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        document.getElementById('rankingBody').innerHTML = html;
    } else {
        // MONITOR: V√™ apenas sua posi√ß√£o
        const minhaPosicao = rankingData.find(m => m.id === currentUser.id);
        const totalMonitores = rankingData.length;
        const pontuacao = calcularPontuacaoTotal(currentUser);
        const nivelInfo = getNivelInfo(pontuacao.total);
        
        const html = `
            <tr style="background: #eef2ff;">
                <td colspan="4" style="padding: 30px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        ${minhaPosicao ? 'üèÜ' : 'üìä'}
                    </div>
                    <h3 style="margin: 0 0 10px 0; color: #6366f1;">
                        Voc√™ est√° em ${minhaPosicao ? minhaPosicao.posicao + '¬∞' : 'N/A'} lugar
                    </h3>
                    <p style="color: #64748b; margin: 10px 0;">
                        Entre ${totalMonitores} monitores ativos
                    </p>
                    <div style="margin-top: 20px; display: inline-flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <span class="rank-badge badge-total">${pontuacao.total} pontos totais</span>
                        <span class="rank-badge badge-mes">Avalia√ß√£o: ${pontuacao.avaliacao}/10</span>
                        <span class="rank-badge badge-medalha">${(currentUser.medalhas || []).length}/7 medalhas</span>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; display: inline-block;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">Seu N√≠vel Atual</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${nivelInfo.cor};">
                            ${nivelInfo.nome}
                        </div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                            ${nivelInfo.descricao}
                        </div>
                    </div>
                    ${minhaPosicao && minhaPosicao.posicao <= 3 ? `
                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 8px; color: #1e293b;">
                            <strong>üåü Parab√©ns! Voc√™ est√° no TOP 3!</strong>
                        </div>
                    ` : ''}
                </td>
            </tr>
        `;

        document.getElementById('rankingBody').innerHTML = html;
    }
}

        // ==================== PERFIL ====================
        function atualizarPerfil() {
            document.getElementById('perfilAvatar').textContent = getInitials(currentUser.nome);
            document.getElementById('perfilNome').textContent = currentUser.nome;
            document.getElementById('perfilTurma').textContent = currentUser.turma;
            document.getElementById('perfilLevel').textContent = calcularNivel(currentUser.pontuacao || 0);
            document.getElementById('perfilCPF').textContent = formatCPF(currentUser.cpf);
            document.getElementById('perfilCelular').textContent = currentUser.celular;
            document.getElementById('perfilData').textContent = formatDate(currentUser.dataNascimento);

            // Medalhas
            const medalhasHtml = (currentUser.medalhas || []).length > 0
                ? currentUser.medalhas.map(medalhaId => {
                    const medalha = MEDALHAS.find(m => m.id === medalhaId);
                    return medalha ? `
                        <div class="medal-card unlocked">
                            <div style="font-size: 32px;">${medalha.nome.split(' ')[0]}</div>
                            <div style="font-size: 11px; font-weight: bold; margin-top: 5px;">${medalha.nome.substring(2)}</div>
                            <div style="font-size: 10px; color: #64748b; margin-top: 3px;">${medalha.descricao}</div>
                        </div>
                    ` : '';
                }).join('')
                : '<p style="color: #64748b; text-align: center; grid-column: 1 / -1;">Nenhuma medalha ainda</p>';

            document.getElementById('perfilMedalhas').innerHTML = medalhasHtml;
        }

        // ==================== ADMIN FUNCTIONS ====================
        function atualizarAdminDashboard() {
            const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
            const tarefasAtivas = tarefas.filter(t => t.status !== 'Conclu√≠da');
            const tarefasPendentes = tarefas.filter(t => t.status === 'Pendente');
            
            const mesAtual = new Date().toISOString().substr(0, 7);
            const avaliacoesDoMes = avaliacoes.filter(a => a.mes === mesAtual);

            document.getElementById('adminTotalMonitores').textContent = monitoresAtivos.length;
            document.getElementById('adminTarefasAtivas').textContent = tarefasAtivas.length;
            document.getElementById('adminTarefasPendentes').textContent = tarefasPendentes.length;
            document.getElementById('adminAvaliacoes').textContent = avaliacoesDoMes.length;

            // Atividade recente
            const tarefasRecentes = tarefas.slice(-5).reverse();
            const atividadesHtml = tarefasRecentes.length > 0
                ? tarefasRecentes.map(t => {
                    const monitor = monitores.find(m => m.id === t.monitorId);
                    return `
                        <div style="padding: 10px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                            <span style="font-weight: 600;">${monitor?.nome || 'N/A'}</span> - ${t.titulo}
                            <div style="color: #64748b; font-size: 11px; margin-top: 3px;">
                                ${t.status} ‚Ä¢ ${formatDate(t.prazo)}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #64748b; text-align: center; padding: 20px;">Nenhuma atividade recente</p>';
            document.getElementById('adminAtividadeRecente').innerHTML = atividadesHtml;
}

function atualizarGerenciarMonitores() {
    const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
    
    const html = monitoresAtivos.length > 0
        ? monitoresAtivos.map(m => {
            const pontuacao = calcularPontuacaoTotal(m);
            const nivel = getNivelInfo(pontuacao.total);
            return `
                <tr>
                    <td>
                        <div>${m.nome}</div>
                        <div style="font-size: 11px; color: ${nivel.cor}; font-weight: bold; margin-top: 3px;">
                            ${nivel.nome}
                        </div>
                    </td>
                    <td>${formatCPF(m.cpf)}</td>
                    <td>${m.turma}</td>
                    <td>
                        <div style="font-weight: bold; color: #6366f1;">${pontuacao.total} pts</div>
                        <div style="font-size: 11px; color: #64748b;">
                            Aval: ${pontuacao.avaliacao} | Med: ${pontuacao.medalhas}
                        </div>
                        <div style="font-size: 11px; color: #64748b;">${(m.medalhas || []).length}/7 üèÖ</div>
                    </td>
                    <td>
                        <button class="btn-sm btn-info" onclick="editarMonitor('${m.id}')">Editar</button>
                        <button class="btn-sm btn-danger" onclick="confirmarExclusaoMonitor('${m.id}', '${m.nome}')">Excluir</button>
                    </td>
                </tr>
            `;
        }).join('')
        : '<tr><td colspan="5" style="text-align: center; color: #64748b; padding: 30px;">Nenhum monitor cadastrado</td></tr>';

    document.getElementById('tabelaMonitores').innerHTML = html;
}

        async function confirmarExclusaoMonitor(monitorId, nomeMonitor) {
            if (!confirm(`Tem certeza que deseja excluir o monitor "${nomeMonitor}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            try {
                console.log('Excluindo monitor:', monitorId);
                await db.collection('monitores').doc(monitorId).delete();
                console.log('Monitor exclu√≠do com sucesso');
                
                // Recarregar dados
                await carregarMonitores();
                atualizarGerenciarMonitores();
                alert('Monitor exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir monitor:', error);
                alert('Erro ao excluir monitor: ' + error.message);
            }
        }

        function atualizarGerenciarTarefas() {
            const html = tarefas.length > 0
                ? tarefas.map(t => {
                    const monitor = monitores.find(m => m.id === t.monitorId);
                    return `
                        <div class="activity-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>${t.titulo}</strong>
                                <div style="display: flex; gap: 5px;">
                                    <span class="urgency-tag ${getUrgenciaClass(t.urgencia)}">${t.urgencia}</span>
                                    <span class="status-badge ${getStatusClass(t.status)}">${t.status}</span>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">${t.descricao}</p>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                                üë§ Monitor: ${monitor?.nome || 'N/A'}<br>
                                üìÖ Prazo: ${formatDate(t.prazo)}
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-sm btn-info" onclick="editarTarefa('${t.id}')">Editar</button>
                                <button class="btn-sm btn-danger" onclick="excluirTarefa('${t.id}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #64748b; text-align: center; padding: 20px;">Nenhuma tarefa cadastrada</p>';

            document.getElementById('adminListaTarefas').innerHTML = html;
        }
// ==================== GERENCIAR ADMINS ====================

function atualizarTabelaAdmins() {
    const admins = monitores.filter(m => m.tipo === 'admin');
    
    const html = admins.length > 0
        ? admins.map(a => `
            <tr>
                <td>${a.nome}</td>
                <td>${formatCPF(a.cpf)}</td>
                <td>${a.celular || 'N/A'}</td>
                <td>
                    <button class="btn-sm btn-info" onclick="editarAdmin('${a.id}')">
                        ‚úèÔ∏è Editar
                    </button>
                    ${admins.length > 1 && a.id !== currentUser.id ? `
                        <button class="btn-sm btn-danger" onclick="confirmarExclusaoAdmin('${a.id}', '${a.nome}')">
                            üóëÔ∏è Excluir
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('')
        : '<tr><td colspan="4" style="text-align: center; color: #64748b; padding: 20px;">Nenhum administrador encontrado</td></tr>';
    
    document.getElementById('tabelaAdmins').innerHTML = html;
}

function openNovoAdminModal() {
    document.getElementById('adminModalTitulo').textContent = 'Adicionar Administrador';
    document.getElementById('adminId').value = '';
    document.getElementById('adminNome').value = '';
    document.getElementById('adminCPF').value = '';
    document.getElementById('adminCelular').value = '';
    clearPinInputs('adminPinGroup');
    document.getElementById('adminModal').classList.add('show');
}

function editarAdmin(adminId) {
    const admin = monitores.find(m => m.id === adminId);
    if (!admin) return;
    
    document.getElementById('adminModalTitulo').textContent = 'Editar Administrador';
    document.getElementById('adminId').value = admin.id;
    document.getElementById('adminNome').value = admin.nome;
    document.getElementById('adminCPF').value = admin.cpf;
    document.getElementById('adminCelular').value = admin.celular || '';
    clearPinInputs('adminPinGroup');
    
    document.getElementById('adminModal').classList.add('show');
}

function fecharAdminModal() {
    document.getElementById('adminModal').classList.remove('show');
    document.getElementById('adminId').value = '';
    document.getElementById('adminNome').value = '';
    document.getElementById('adminCPF').value = '';
    document.getElementById('adminCelular').value = '';
    clearPinInputs('adminPinGroup');
}

async function salvarAdmin() {
    const id = document.getElementById('adminId').value;
    const nome = document.getElementById('adminNome').value.trim();
    const cpf = document.getElementById('adminCPF').value.trim();
    const celular = document.getElementById('adminCelular').value.trim();
    const pin = getPinValue('adminPinGroup');
    
    // Valida√ß√µes
    if (!nome || !cpf) {
        showError('adminModalError', 'Preencha nome e CPF');
        return;
    }
    
    if (cpf.length !== 11) {
        showError('adminModalError', 'CPF deve ter 11 d√≠gitos');
        return;
    }
    
    // Se for novo admin, PIN √© obrigat√≥rio
    if (!id && pin.length !== 4) {
        showError('adminModalError', 'PIN de 4 d√≠gitos √© obrigat√≥rio para novo admin');
        return;
    }
    
    // Se est√° editando e forneceu PIN, validar
    if (id && pin.length > 0 && pin.length !== 4) {
        showError('adminModalError', 'PIN deve ter 4 d√≠gitos');
        return;
    }
    
    try {
        const data = {
            nome,
            cpf,
            celular: celular || null,
            tipo: 'admin'
        };
        
        // Adicionar PIN apenas se fornecido
        if (pin.length === 4) {
            data.pin = pin;
        }
        
        if (id) {
            // Atualizar admin existente
            console.log('Atualizando admin:', id);
            
            // Se n√£o forneceu novo PIN, remover do objeto
            if (pin.length === 0) {
                delete data.pin;
            }
            
            await db.collection('monitores').doc(id).update(data);
            console.log('Admin atualizado com sucesso');
            
            // Atualizar dados do usu√°rio atual se for ele mesmo
            if (id === currentUser.id) {
                currentUser.nome = nome;
                currentUser.cpf = cpf;
                currentUser.celular = celular;
            }
        } else {
            // Verificar se CPF j√° existe
            const snapshot = await db.collection('monitores')
                .where('cpf', '==', cpf)
                .get();
            
            if (!snapshot.empty) {
                showError('adminModalError', 'CPF j√° cadastrado no sistema');
                return;
            }
            
            // Criar novo admin
            data.dataCadastro = firebase.firestore.FieldValue.serverTimestamp();
            data.medalhas = [];
            
            console.log('Criando novo admin:', data);
            await db.collection('monitores').add(data);
            console.log('Admin criado com sucesso');
        }
        
        fecharAdminModal();
        alert(id ? 'Administrador atualizado com sucesso!' : 'Administrador adicionado com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar admin:', error);
        showError('adminModalError', 'Erro ao salvar: ' + error.message);
    }
}

async function confirmarExclusaoAdmin(adminId, nomeAdmin) {
    const admins = monitores.filter(m => m.tipo === 'admin');
    
    // Prote√ß√µes
    if (admins.length === 1) {
        alert('‚ö†Ô∏è N√£o √© poss√≠vel excluir o √∫ltimo administrador do sistema!');
        return;
    }
    
    if (adminId === currentUser.id) {
        alert('‚ö†Ô∏è Voc√™ n√£o pode excluir sua pr√≥pria conta!');
        return;
    }
    
    if (!confirm(`Tem certeza que deseja excluir o administrador "${nomeAdmin}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
    }
    
    try {
        console.log('Excluindo admin:', adminId);
        await db.collection('monitores').doc(adminId).delete();
        console.log('Admin exclu√≠do com sucesso');
        alert('Administrador exclu√≠do com sucesso!');
    } catch (error) {
        console.error('Erro ao excluir admin:', error);
        alert('Erro ao excluir administrador: ' + error.message);
    }
}
        // ==================== MODAL FUNCTIONS ====================
        function openNovoMonitorModal() {
            document.getElementById('monitorModalTitulo').textContent = 'Novo Monitor';
            document.getElementById('monitorId').value = '';
            document.getElementById('monitorNome').value = '';
            document.getElementById('monitorCPF').value = '';
            document.getElementById('monitorCelular').value = '';
            document.getElementById('monitorData').value = '';
            document.getElementById('monitorTurma').value = '';
            clearPinInputs('monitorPinGroup');
            document.getElementById('monitorModal').classList.add('show');
        }

        function editarMonitor(monitorId) {
            const monitor = monitores.find(m => m.id === monitorId);
            if (!monitor) return;

            document.getElementById('monitorModalTitulo').textContent = 'Editar Monitor';
            document.getElementById('monitorId').value = monitor.id;
            document.getElementById('monitorNome').value = monitor.nome;
            document.getElementById('monitorCPF').value = monitor.cpf;
            document.getElementById('monitorCelular').value = monitor.celular;
            document.getElementById('monitorData').value = monitor.dataNascimento;
            document.getElementById('monitorTurma').value = monitor.turma;
            document.getElementById('monitorModal').classList.add('show');
        }

        function fecharMonitorModal() {
            document.getElementById('monitorModal').classList.remove('show');
        }

        async function salvarMonitor() {
            const id = document.getElementById('monitorId').value;
            const nome = document.getElementById('monitorNome').value.trim();
            const cpf = document.getElementById('monitorCPF').value.trim();
            const celular = document.getElementById('monitorCelular').value.trim();
            const dataNascimento = document.getElementById('monitorData').value;
            const turma = document.getElementById('monitorTurma').value;
            const pin = getPinValue('monitorPinGroup');

            // Valida√ß√µes
            if (!nome || !cpf || !celular || !dataNascimento || !turma) {
                showError('monitorModalError', 'Preencha todos os campos obrigat√≥rios');
                return;
            }

            if (cpf.length !== 11) {
                showError('monitorModalError', 'CPF deve ter 11 d√≠gitos');
                return;
            }

            if (!id && pin.length !== 4) {
                showError('monitorModalError', 'PIN deve ter 4 d√≠gitos para novo monitor');
                return;
            }

            try {
                const data = {
                    nome,
                    cpf,
                    celular,
                    dataNascimento,
                    turma
                };

                // Adicionar PIN se fornecido
                if (pin.length === 4) {
                    data.pin = pin;
                }

                if (id) {
                    // Atualizar monitor existente
                    console.log('Atualizando monitor:', id);
                    await db.collection('monitores').doc(id).update(data);
                    console.log('Monitor atualizado com sucesso');
                } else {
                    // Verificar se CPF j√° existe
                    const snapshot = await db.collection('monitores')
                        .where('cpf', '==', cpf)
                        .get();

                    if (!snapshot.empty) {
                        showError('monitorModalError', 'CPF j√° cadastrado no sistema');
                        return;
                    }

                    // Criar novo monitor
                    data.tipo = 'monitor';
                    data.medalhas = [];
                    data.dataCadastro = firebase.firestore.FieldValue.serverTimestamp();
                    
                    console.log('Criando novo monitor:', data);
                    await db.collection('monitores').add(data);
                    console.log('Monitor criado com sucesso');
                }

                // Recarregar dados
                await carregarMonitores();
                atualizarGerenciarMonitores();
                fecharMonitorModal();
                alert(id ? 'Monitor atualizado com sucesso!' : 'Monitor cadastrado com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar monitor:', error);
                showError('monitorModalError', 'Erro ao salvar: ' + error.message);
            }
        }

        async function excluirTarefa(tarefaId) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (!tarefa) return;
            
            if (!confirm(`Tem certeza que deseja excluir a tarefa "${tarefa.titulo}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            try {
                console.log('Excluindo tarefa:', tarefaId);
                await db.collection('tarefas').doc(tarefaId).delete();
                console.log('Tarefa exclu√≠da com sucesso');
                
                // Recarregar dados
                await carregarTarefas();
                atualizarGerenciarTarefas();
                if (currentUser.tipo !== 'admin') {
                    atualizarTarefas();
                }
                alert('Tarefa exclu√≠da com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                alert('Erro ao excluir tarefa: ' + error.message);
            }
        }

function openNovaTarefaModal() {
    document.getElementById('tarefaModalTitulo').textContent = 'Nova Tarefa';
    document.getElementById('tarefaId').value = '';
    document.getElementById('tarefaTitulo').value = '';
    document.getElementById('tarefaDescricao').value = '';
    document.getElementById('tarefaPrazo').value = '';
    document.getElementById('tarefaUrgencia').value = 'Baixa';
    
    // Preencher checkboxes de monitores
    const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
    document.getElementById('tarefaMonitores').innerHTML = monitoresAtivos.map(m => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; cursor: pointer; margin-bottom: 5px;">
            <input type="checkbox" value="${m.id}" class="monitor-checkbox" style="width: 18px; height: 18px;">
            <span style="font-size: 13px;">${m.nome} - ${m.turma}</span>
        </label>
    `).join('');
    
    document.getElementById('tarefaModal').classList.add('show');
}

function openNovaTarefaModal() {
    document.getElementById('tarefaModalTitulo').textContent = 'Nova Tarefa';
    document.getElementById('tarefaId').value = '';
    document.getElementById('tarefaTitulo').value = '';
    document.getElementById('tarefaDescricao').value = '';
    document.getElementById('tarefaPrazo').value = '';
    document.getElementById('tarefaUrgencia').value = 'Baixa';
    
    // Preencher checkboxes de monitores
    const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
    document.getElementById('tarefaMonitores').innerHTML = monitoresAtivos.map(m => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; cursor: pointer; margin-bottom: 5px;">
            <input type="checkbox" value="${m.id}" class="monitor-checkbox" style="width: 18px; height: 18px;">
            <span style="font-size: 13px;">${m.nome} - ${m.turma}</span>
        </label>
    `).join('');
    
    document.getElementById('tarefaModal').classList.add('show');
}

function editarTarefa(tarefaId) {
    const tarefa = tarefas.find(t => t.id === tarefaId);
    if (!tarefa) return;

    document.getElementById('tarefaModalTitulo').textContent = 'Editar Tarefa';
    document.getElementById('tarefaId').value = tarefa.id;
    document.getElementById('tarefaTitulo').value = tarefa.titulo;
    document.getElementById('tarefaDescricao').value = tarefa.descricao;
    document.getElementById('tarefaPrazo').value = tarefa.prazo;
    document.getElementById('tarefaUrgencia').value = tarefa.urgencia;
    
    // Preencher checkboxes com monitores selecionados
    const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
    const monitoresSelecionados = Array.isArray(tarefa.monitoresIds) ? tarefa.monitoresIds : [tarefa.monitorId];
    
    document.getElementById('tarefaMonitores').innerHTML = monitoresAtivos.map(m => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; cursor: pointer; margin-bottom: 5px;">
            <input type="checkbox" value="${m.id}" class="monitor-checkbox" 
                   ${monitoresSelecionados.includes(m.id) ? 'checked' : ''}
                   style="width: 18px; height: 18px;">
            <span style="font-size: 13px;">${m.nome} - ${m.turma}</span>
        </label>
    `).join('');
    
    document.getElementById('tarefaModal').classList.add('show');
}

function fecharTarefaModal() {
    document.getElementById('tarefaModal').classList.remove('show');
    
    // Limpar campos
    document.getElementById('tarefaId').value = '';
    document.getElementById('tarefaTitulo').value = '';
    document.getElementById('tarefaDescricao').value = '';
    document.getElementById('tarefaPrazo').value = '';
    document.getElementById('tarefaUrgencia').value = 'Baixa';
    
    // Limpar checkboxes
    const checkboxes = document.querySelectorAll('.monitor-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    
    // Limpar erro se houver
    const errorEl = document.getElementById('tarefaModalError');
    if (errorEl) {
        errorEl.classList.add('hidden');
    }
}

async function salvarTarefa() {
    const id = document.getElementById('tarefaId').value;
    const titulo = document.getElementById('tarefaTitulo').value.trim();
    const descricao = document.getElementById('tarefaDescricao').value.trim();
    const prazo = document.getElementById('tarefaPrazo').value;
    const urgencia = document.getElementById('tarefaUrgencia').value;
    
    // Pegar monitores selecionados
    const checkboxes = document.querySelectorAll('.monitor-checkbox:checked');
    const monitoresSelecionados = Array.from(checkboxes).map(cb => cb.value);

    // Valida√ß√µes
    if (!titulo || !descricao || !prazo) {
        showError('tarefaModalError', 'Preencha t√≠tulo, descri√ß√£o e prazo');
        return;
    }
    
    if (monitoresSelecionados.length === 0) {
        showError('tarefaModalError', 'Selecione pelo menos um monitor');
        return;
    }

    try {
        const data = {
            titulo,
            descricao,
            prazo,
            urgencia,
            monitoresIds: monitoresSelecionados,
            monitorId: monitoresSelecionados[0], // Compatibilidade
            status: id ? undefined : 'Pendente'
        };

        // Remover campos undefined
        Object.keys(data).forEach(key => data[key] === undefined && delete data[key]);

        if (id) {
            // Atualizar tarefa existente
            console.log('Atualizando tarefa:', id);
            await db.collection('tarefas').doc(id).update(data);
            console.log('Tarefa atualizada com sucesso');
        } else {
            // Criar nova tarefa
            data.status = 'Pendente';
            data.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
            console.log('Criando nova tarefa:', data);
            await db.collection('tarefas').add(data);
            console.log('Tarefa criada com sucesso');
        }

        // Recarregar dados
        await carregarTarefas();
        atualizarGerenciarTarefas();
        if (currentUser.tipo !== 'admin') {
            atualizarTarefas();
        }
        fecharTarefaModal();
        alert(id ? 'Tarefa atualizada com sucesso!' : 'Tarefa criada com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar tarefa:', error);
        showError('tarefaModalError', 'Erro ao salvar: ' + error.message);
    }
}

        // ==================== AVALIA√á√ÉO ====================
        function carregarMonitoresParaAvaliar() {
            const mes = document.getElementById('mesAvaliacao').value;
            if (!mes) {
                document.getElementById('listaMonitoresAvaliar').innerHTML = '<p style="color: #64748b; text-align: center;">Selecione um m√™s</p>';
                return;
            }

            const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
            const html = monitoresAtivos.map(m => {
                const avaliacaoExistente = avaliacoes.find(a => a.monitorId === m.id && a.mes === mes);
                return `
                    <div class="activity-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${m.nome}</strong>
                                <div style="font-size: 12px; color: #64748b;">${m.turma}</div>
                            </div>
                            ${avaliacaoExistente 
                                ? '<span class="status-badge done">Avaliado</span>' 
                                : `<button class="btn-sm btn-success" onclick="openAvaliacaoModal('${m.id}', '${mes}')">Avaliar</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('listaMonitoresAvaliar').innerHTML = html;
        }

        function openAvaliacaoModal(monitorId, mes) {
            const monitor = monitores.find(m => m.id === monitorId);
            if (!monitor) return;

            document.getElementById('avaliacaoMonitorId').value = monitorId;
            document.getElementById('avaliacaoMes').value = mes;
            document.getElementById('avaliacaoNome').textContent = monitor.nome;
            document.getElementById('avaliacaoTurma').textContent = monitor.turma;

            // Reset rubricas
            document.getElementById('rubricaResponsabilidade').value = '2';
            document.getElementById('rubricaTrabalhoColetivo').value = '2';
            document.getElementById('rubricaIniciativa').value = '2';
            document.getElementById('rubricaComunicacao').value = '2';
            document.getElementById('rubricaProjetos').value = '2';

            // Carregar medalhas com √≠cones
            const medalhasHtml = MEDALHAS.map(m => {
                const conquistada = (monitor.medalhas || []).includes(m.id);
                return `
                    <div class="medal-card ${conquistada ? 'unlocked selected' : ''}" 
                         onclick="toggleMedalha('${m.id}')" 
                         id="medalha-${m.id}"
                         title="${m.descricao}">
                        <div style="font-size: 32px;">${m.icon}</div>
                        <div style="font-size: 11px; font-weight: bold; margin-top: 5px;">${m.nome}</div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 3px;">${m.descricao}</div>
                        <div style="margin-top: 5px; color: #10b981; font-weight: bold; font-size: 11px;">+${m.pontos} pts</div>
                    </div>
                `;
            }).join('');
            document.getElementById('medalhasAvaliacao').innerHTML = medalhasHtml;

            document.getElementById('avaliacaoModal').classList.add('show');
        }

        function fecharAvaliacaoModal() {
            document.getElementById('avaliacaoModal').classList.remove('show');
        }

        function toggleMedalha(medalhaId) {
            const el = document.getElementById(`medalha-${medalhaId}`);
            el.classList.toggle('selected');
        }

        async function salvarAvaliacao() {
            const monitorId = document.getElementById('avaliacaoMonitorId').value;
            const mes = document.getElementById('avaliacaoMes').value;

            if (!monitorId || !mes) {
                showError('avaliacaoModalError', 'Dados de avalia√ß√£o incompletos');
                return;
            }

            const rubricas = {
                Responsabilidade: parseInt(document.getElementById('rubricaResponsabilidade').value),
                TrabalhoColetivo: parseInt(document.getElementById('rubricaTrabalhoColetivo').value),
                Iniciativa: parseInt(document.getElementById('rubricaIniciativa').value),
                Comunicacao: parseInt(document.getElementById('rubricaComunicacao').value),
                Projetos: parseInt(document.getElementById('rubricaProjetos').value)
            };

            // Coletar medalhas selecionadas
            const medalhasSelecionadas = [];
            MEDALHAS.forEach(m => {
                const el = document.getElementById(`medalha-${m.id}`);
                if (el && el.classList.contains('selected')) {
                    medalhasSelecionadas.push(m.id);
                }
            });

            try {
               // Pontos da avalia√ß√£o do m√™s (cada rubrica vale 0-2, total 10 pontos)
               const totalRubricas = Object.values(rubricas).reduce((a, b) => a + b, 0);
               const pontuacaoMes = totalRubricas; // Pontua√ß√£o direta (0-10)

                // Verificar se j√° existe avalia√ß√£o para este monitor neste m√™s
                const existente = await db.collection('avaliacoes')
                    .where('monitorId', '==', monitorId)
                    .where('mes', '==', mes)
                    .get();

                const avaliacaoData = {
                    monitorId,
                    mes,
                    rubricas,
                    medalhas: medalhasSelecionadas,
                    pontuacao: pontuacaoMes,
                    dataAvaliacao: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (!existente.empty) {
                    // Atualizar avalia√ß√£o existente
                    const docId = existente.docs[0].id;
                    console.log('Atualizando avalia√ß√£o existente:', docId);
                    await db.collection('avaliacoes').doc(docId).update(avaliacaoData);
                    console.log('Avalia√ß√£o atualizada com sucesso');
                } else {
                    // Criar nova avalia√ß√£o
                    console.log('Criando nova avalia√ß√£o:', avaliacaoData);
                    await db.collection('avaliacoes').add(avaliacaoData);
                    console.log('Avalia√ß√£o criada com sucesso');
                }

                // Atualizar medalhas permanentes do monitor
                // Medalhas s√£o permanentes, ent√£o fazemos merge com as existentes
                const monitor = monitores.find(m => m.id === monitorId);
                if (monitor) {
                    const medalhasAtuais = new Set(monitor.medalhas || []);
                    medalhasSelecionadas.forEach(m => medalhasAtuais.add(m));
                    
                    console.log('Atualizando medalhas do monitor');
                    await db.collection('monitores').doc(monitorId).update({
                        medalhas: Array.from(medalhasAtuais)
                    });
                    console.log('Monitor atualizado com sucesso');
                }

                // Recarregar todos os dados
// Recarregar todos os dados
await carregarMonitores();
await carregarAvaliacoes();
carregarMonitoresParaAvaliar();

// Atualizar interface do admin
if (currentUser.tipo === 'admin') {
    atualizarDashboardAdmin();
    atualizarGerenciarMonitores();
    atualizarRanking();
} else {
    atualizarAvaliacoes();
    atualizarDashboard();
}

fecharAvaliacaoModal();
alert('Avalia√ß√£o salva com sucesso!\n\nPontos do m√™s: ' + pontuacaoMes + '\nMedalhas: ' + medalhasSelecionadas.length);
            } catch (error) {
                console.error('Erro ao salvar avalia√ß√£o:', error);
                showError('avaliacaoModalError', 'Erro ao salvar: ' + error.message);
            }
        }

        // ==================== INICIALIZA√á√ÉO ====================
        // Fun√ß√£o para aguardar o Firebase estar dispon√≠vel
        function aguardarFirebase() {
            return new Promise((resolve, reject) => {
                let tentativas = 0;
                const maxTentativas = 100; // 10 segundos
                
                const verificar = setInterval(() => {
                    tentativas++;
                    
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        clearInterval(verificar);
                        console.log('‚úÖ Firebase carregado ap√≥s', tentativas * 100, 'ms');
                        resolve();
                    } else if (tentativas >= maxTentativas) {
                        clearInterval(verificar);
                        reject(new Error('Firebase n√£o carregou ap√≥s 10 segundos'));
                    } else {
                        console.log('‚è≥ Aguardando Firebase... tentativa', tentativas);
                    }
                }, 100);
            });
        }

        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando SIMON...');
            
            const loadingBar = document.getElementById('loadingBar');
            const setProgress = (percent) => {
                if (loadingBar) loadingBar.style.width = percent + '%';
            };
            
            try {
                setProgress(10);
                
                // Aguardar Firebase estar dispon√≠vel
                console.log('‚è≥ Aguardando Firebase...');
                await aguardarFirebase();
                console.log('‚úÖ Firebase detectado!');
                setProgress(30);
                
                // Inicializar Firebase
                console.log('üîß Inicializando Firebase...');
                initFirebase();
                setProgress(50);
                
                // Verificar conex√£o
                console.log('üîç Verificando conex√£o com Firebase...');
                const conectado = await verificarConexaoFirebase();
                if (!conectado) {
                    console.error('‚ùå Falha na verifica√ß√£o de conex√£o');
                    throw new Error('N√£o foi poss√≠vel conectar ao Firebase');
                }
                setProgress(70);
                
                // Criar admin padr√£o se n√£o existir
                console.log('üë§ Verificando admin padr√£o...');
                await criarAdminPadrao();
                setProgress(85);
                
                // Setup PIN inputs - IMPORTANTE: fazer depois do DOM estar pronto
                setTimeout(() => {
                    console.log('‚öôÔ∏è Configurando inputs de PIN...');
                    setupPinInputs('loginPinGroup');
                    setupPinInputs('regPinGroup');
                    setupPinInputs('monitorPinGroup');
                    setupPinInputs('adminPinGroup');
                    console.log('‚úÖ Inputs de PIN configurados');
                }, 200);

                // Verificar sess√£o
                const userId = sessionStorage.getItem('userId');
                if (userId) {
                    try {
                        console.log('üîÑ Restaurando sess√£o...');
                        const doc = await db.collection('monitores').doc(userId).get();
                        if (doc.exists) {
                            currentUser = { id: doc.id, ...doc.data() };
                            await startApp();
                            return; // N√£o mostrar tela de login
                        } else {
                            sessionStorage.removeItem('userId');
                        }
                    } catch (error) {
                        console.error('Erro ao restaurar sess√£o:', error);
                        sessionStorage.removeItem('userId');
                    }
                }

                // Set default month for evaluation
                const today = new Date();
                document.getElementById('mesAvaliacao').value = today.toISOString().substr(0, 7);
                
                setProgress(100);
                console.log('‚úÖ Sistema inicializado com sucesso!');
                
                // Mostrar formul√°rio de login
                setTimeout(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    // Focar no primeiro campo
                    document.getElementById('loginCPF').focus();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div style="color: #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                        <h3>Erro ao Carregar Sistema</h3>
                        <p style="color: #64748b; font-size: 13px; margin: 20px 0;">
                            ${error.message}
                        </p>
                        <ul style="text-align: left; color: #64748b; margin: 20px; font-size: 12px;">
                            <li>Verifique sua conex√£o com a internet</li>
                            <li>Tente recarregar a p√°gina (F5)</li>
                            <li>Use modo an√¥nimo do navegador</li>
                            <li>Desative extens√µes/bloqueadores</li>
                        </ul>
                        <button class="btn" onclick="location.reload()">üîÑ Recarregar P√°gina</button>
                    </div>
                `;
            }
        });

        // Criar administrador padr√£o
        async function criarAdminPadrao() {
            try {
                const snapshot = await db.collection('monitores')
                    .where('cpf', '==', '00000000000')
                    .get();

                if (snapshot.empty) {
                    console.log('Criando administrador padr√£o...');
                    await db.collection('monitores').add({
                        nome: 'Administrador',
                        cpf: '00000000000',
                        celular: '(00) 00000-0000',
                        pin: '1234',
                        tipo: 'admin',
                        dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Administrador padr√£o criado!');
                    console.log('CPF: 00000000000 | PIN: 1234');
                }
            } catch (error) {
                console.error('Erro ao criar admin padr√£o:', error);
            }
        }

        // ==================== ADMIN CONFIG FUNCTIONS ====================
function atualizarConfigAdmin() {
    // 1. Localiza os elementos
    const elListaAdmins = document.getElementById('listaAdmins');
    const elEstatisticas = document.getElementById('estatisticasGerais');

    // 2. S√ì EXECUTA SE OS ELEMENTOS EXISTIREM (Isso evita o erro de "null")
    if (elListaAdmins) {
        const admins = monitores.filter(m => m.tipo === 'admin');
        const adminsHtml = admins.length > 0
            ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Celular</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${admins.map(a => `
                            <tr>
                                <td>${a.nome}</td>
                                <td>${formatCPF(a.cpf)}</td>
                                <td>${a.celular}</td>
                                <td>
                                    <button class="btn-sm btn-info" onclick="editarMonitor('${a.id}')">Editar</button>
                                    <button class="btn-sm btn-danger" onclick="excluirAdmin('${a.id}')">Excluir</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `
            : '<p style="color: #64748b; text-align: center; margin-top: 15px;">Nenhum administrador cadastrado</p>';
        
        elListaAdmins.innerHTML = adminsHtml;
    }

    if (elEstatisticas) {
        const totalMonitores = monitores.filter(m => m.tipo !== 'admin').length;
        const totalTarefas = tarefas.length;
        const tarefasConcluidas = tarefas.filter(t => t.status === 'Conclu√≠da').length;
        const totalAvaliacoes = avaliacoes.length;
        const pontuacaoTotal = monitores.reduce((sum, m) => sum + (m.pontuacao || 0), 0);
        const mediaPontuacao = totalMonitores > 0 ? (pontuacaoTotal / totalMonitores).toFixed(1) : 0;

        const estatisticasHtml = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Total de Monitores</div>
                    <div style="font-size: 24px; font-weight: bold; color: #6366f1;">${totalMonitores}</div>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">M√©dia de Pontua√ß√£o</div>
                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${mediaPontuacao}</div>
                </div>
            </div>`;
        
        elEstatisticas.innerHTML = estatisticasHtml;
    }

    // Se voc√™ tiver a fun√ß√£o atualizarTabelaAdmins, verifique se ela tamb√©m √© segura
    if (typeof atualizarTabelaAdmins === 'function' && elListaAdmins) {
        atualizarTabelaAdmins();
    }
}

        function openNovoAdminModal() {
            document.getElementById('adminNome').value = '';
            document.getElementById('adminCPF').value = '';
            document.getElementById('adminCelular').value = '';
            clearPinInputs('adminPinGroup');
            document.getElementById('adminModal').classList.add('show');
        }

        function fecharAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
        }

        async function salvarAdmin() {
            const nome = document.getElementById('adminNome').value.trim();
            const cpf = document.getElementById('adminCPF').value.trim();
            const celular = document.getElementById('adminCelular').value.trim();
            const pin = getPinValue('adminPinGroup');

            if (!nome || !cpf || !celular || pin.length !== 4) {
                showError('adminModalError', 'Preencha todos os campos');
                return;
            }

            if (cpf.length !== 11) {
                showError('adminModalError', 'CPF deve ter 11 d√≠gitos');
                return;
            }

            try {
                // Verificar se CPF j√° existe
                const snapshot = await db.collection('monitores')
                    .where('cpf', '==', cpf)
                    .get();

                if (!snapshot.empty) {
                    showError('adminModalError', 'CPF j√° cadastrado');
                    return;
                }

                // Criar admin
                const novoAdmin = {
                    nome,
                    cpf,
                    celular,
                    pin,
                    tipo: 'admin',
                    dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('monitores').add(novoAdmin);
                await carregarMonitores();
                atualizarConfigAdmin();
                fecharAdminModal();
                alert('Administrador adicionado com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar admin:', error);
                showError('adminModalError', 'Erro ao adicionar administrador');
            }
        }

        async function excluirAdmin(adminId) {
            if (!confirm('Tem certeza que deseja excluir este administrador?')) return;

            // Verificar se n√£o √© o √∫ltimo admin
            const admins = monitores.filter(m => m.tipo === 'admin');
            if (admins.length <= 1) {
                alert('N√£o √© poss√≠vel excluir o √∫ltimo administrador do sistema!');
                return;
            }

            // Verificar se n√£o est√° excluindo a si mesmo
            if (adminId === currentUser.id) {
                alert('Voc√™ n√£o pode excluir sua pr√≥pria conta!');
                return;
            }

            try {
                await db.collection('monitores').doc(adminId).delete();
                await carregarMonitores();
                atualizarConfigAdmin();
                alert('Administrador exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir admin:', error);
                alert('Erro ao excluir administrador');
            }
        }

        async function limparAvaliacoesAntigas() {
            const meses = parseInt(prompt('Excluir avalia√ß√µes com mais de quantos meses?', '6'));
            if (!meses || isNaN(meses)) return;

            if (!confirm(`Tem certeza que deseja excluir avalia√ß√µes com mais de ${meses} meses?`)) return;

            try {
                const dataLimite = new Date();
                dataLimite.setMonth(dataLimite.getMonth() - meses);
                const mesLimite = dataLimite.toISOString().substr(0, 7);

                const batch = db.batch();
                const snapshot = await db.collection('avaliacoes').get();
                
                let count = 0;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.mes && data.mes < mesLimite) {
                        batch.delete(doc.ref);
                        count++;
                    }
                });

                await batch.commit();
                await carregarAvaliacoes();
                alert(`${count} avalia√ß√µes antigas foram exclu√≠das!`);
            } catch (error) {
                console.error('Erro ao limpar avalia√ß√µes:', error);
                alert('Erro ao limpar avalia√ß√µes');
            }
        }

        async function limparTarefasConcluidas() {
            if (!confirm('Tem certeza que deseja excluir TODAS as tarefas conclu√≠das?')) return;

            try {
                const batch = db.batch();
                const snapshot = await db.collection('tarefas')
                    .where('status', '==', 'Conclu√≠da')
                    .get();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                await carregarTarefas();
                atualizarGerenciarTarefas();
                alert(`${snapshot.size} tarefas conclu√≠das foram exclu√≠das!`);
            } catch (error) {
                console.error('Erro ao limpar tarefas:', error);
                alert('Erro ao limpar tarefas');
            }
        }

        async function resetarPontuacoes() {
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o ir√° resetar as pontua√ß√µes e medalhas de TODOS os monitores. Continuar?')) return;
            if (!confirm('Tem CERTEZA ABSOLUTA? Esta a√ß√£o n√£o pode ser desfeita!')) return;

            try {
                const batch = db.batch();
                const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
                
                monitoresAtivos.forEach(m => {
                    const ref = db.collection('monitores').doc(m.id);
                    batch.update(ref, {
                        pontuacao: 0,
                        medalhas: []
                    });
                });

                await batch.commit();
                await carregarMonitores();
                atualizarInterface();
                alert('Pontua√ß√µes e medalhas resetadas com sucesso!');
            } catch (error) {
                console.error('Erro ao resetar pontua√ß√µes:', error);
                alert('Erro ao resetar pontua√ß√µes');
            }
        }

// ==================== EXPORTA√á√ÉO EXCEL ====================

function exportarMonitores() {
    const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
    
    const dados = monitoresAtivos.map(m => {
        const pontuacao = calcularPontuacaoTotal(m);
        const nivel = getNivelInfo(pontuacao.total);
        
        return {
            'Nome': m.nome,
            'CPF': m.cpf,
            'Celular': m.celular,
            'Turma': m.turma,
            'Data Nascimento': formatDate(m.dataNascimento),
            'Pontos Avalia√ß√£o': pontuacao.avaliacao,
            'Pontos Medalhas': pontuacao.medalhas,
            'Pontos Totais': pontuacao.total,
            'N√≠vel': nivel.nome,
            'Quantidade Medalhas': (m.medalhas || []).length,
            'Medalhas': (m.medalhas || []).map(medalhaId => {
                const medalha = MEDALHAS.find(med => med.id === medalhaId);
                return medalha ? medalha.nome : medalhaId;
            }).join(', ')
        };
    });
    
    exportarParaExcel(dados, 'Monitores', 'monitores_simon.xlsx');
}

function exportarTarefas() {
    const dados = tarefas.map(t => {
        // Buscar nomes dos monitores (suporta m√∫ltiplos)
        let monitoresNomes = '';
        if (Array.isArray(t.monitoresIds)) {
            monitoresNomes = t.monitoresIds.map(id => {
                const m = monitores.find(monitor => monitor.id === id);
                return m ? m.nome : 'N/A';
            }).join(', ');
        } else if (t.monitorId) {
            const m = monitores.find(monitor => monitor.id === t.monitorId);
            monitoresNomes = m ? m.nome : 'N/A';
        }
        
        return {
            'T√≠tulo': t.titulo,
            'Monitor(es)': monitoresNomes,
            'Descri√ß√£o': t.descricao,
            'Prazo': formatDate(t.prazo),
            'Urg√™ncia': t.urgencia,
            'Status': t.status,
            'Data Cria√ß√£o': t.dataCriacao ? new Date(t.dataCriacao.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'
        };
    });
    
    exportarParaExcel(dados, 'Tarefas', 'tarefas_simon.xlsx');
}

function exportarAvaliacoes() {
    const dados = avaliacoes.map(a => {
        const monitor = monitores.find(m => m.id === a.monitorId);
        const total = Object.values(a.rubricas || {}).reduce((sum, val) => sum + val, 0);
        
        return {
            'Monitor': monitor?.nome || 'N/A',
            'Turma': monitor?.turma || 'N/A',
            'M√™s': a.mes,
            'Responsabilidade': a.rubricas?.Responsabilidade || 0,
            'Trabalho Coletivo': a.rubricas?.TrabalhoColetivo || 0,
            'Iniciativa': a.rubricas?.Iniciativa || 0,
            'Comunica√ß√£o': a.rubricas?.Comunicacao || 0,
            'Projetos': a.rubricas?.Projetos || 0,
            'Total Rubricas': total,
            'Pontua√ß√£o': a.pontuacao || 0,
            'Quantidade Medalhas': (a.medalhas || []).length,
            'Medalhas do M√™s': (a.medalhas || []).map(medalhaId => {
                const medalha = MEDALHAS.find(med => med.id === medalhaId);
                return medalha ? medalha.nome : medalhaId;
            }).join(', '),
            'Data Avalia√ß√£o': a.dataAvaliacao ? new Date(a.dataAvaliacao.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'
        };
    });
    
    exportarParaExcel(dados, 'Avalia√ß√µes', 'avaliacoes_simon.xlsx');
}

function exportarParaExcel(dados, nomeAba, nomeArquivo) {
    if (!dados || dados.length === 0) {
        alert('Nenhum dado para exportar!');
        return;
    }
    
    try {
        // Criar workbook
        const wb = XLSX.utils.book_new();
        
        // Converter dados para worksheet
        const ws = XLSX.utils.json_to_sheet(dados);
        
        // Ajustar largura das colunas automaticamente
        const colWidths = [];
        const firstRow = dados[0];
        
        Object.keys(firstRow).forEach(key => {
            // Calcular largura baseada no maior valor
            let maxLength = key.length;
            dados.forEach(row => {
                const cellValue = String(row[key] || '');
                if (cellValue.length > maxLength) {
                    maxLength = cellValue.length;
                }
            });
            colWidths.push({ wch: Math.min(maxLength + 2, 50) }); // M√°ximo 50 caracteres
        });
        
        ws['!cols'] = colWidths;
        
        // Adicionar worksheet ao workbook
        XLSX.utils.book_append_sheet(wb, ws, nomeAba);
        
        // Salvar arquivo
        XLSX.writeFile(wb, nomeArquivo);
        
        console.log(`‚úÖ Arquivo ${nomeArquivo} exportado com sucesso!`);
    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        alert('Erro ao exportar para Excel: ' + error.message);
    }
}

function exportarAvaliacoes() {
    const dados = avaliacoes.map(a => {
        const monitor = monitores.find(m => m.id === a.monitorId);
        const total = Object.values(a.rubricas || {}).reduce((sum, val) => sum + val, 0);
        
        return {
            'Monitor': monitor?.nome || 'N/A',
            'Turma': monitor?.turma || 'N/A',
            'M√™s': a.mes,
            'Responsabilidade': a.rubricas?.Responsabilidade || 0,
            'Trabalho Coletivo': a.rubricas?.TrabalhoColetivo || 0,
            'Iniciativa': a.rubricas?.Iniciativa || 0,
            'Comunica√ß√£o': a.rubricas?.Comunicacao || 0,
            'Projetos': a.rubricas?.Projetos || 0,
            'Total Rubricas': total,
            'Pontua√ß√£o': a.pontuacao || 0,
            'Quantidade Medalhas': (a.medalhas || []).length,
            'Medalhas do M√™s': (a.medalhas || []).map(medalhaId => {
                const medalha = MEDALHAS.find(med => med.id === medalhaId);
                return medalha ? medalha.nome : medalhaId;
            }).join(', '),
            'Data Avalia√ß√£o': a.dataAvaliacao ? new Date(a.dataAvaliacao.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'
        };
    });
    
    exportarParaExcel(dados, 'Avalia√ß√µes', 'avaliacoes_simon.xlsx');
}

function exportarParaExcel(dados, nomeAba, nomeArquivo) {
    // Criar workbook
    const wb = XLSX.utils.book_new();
    
    // Converter dados para worksheet
    const ws = XLSX.utils.json_to_sheet(dados);
    
    // Ajustar largura das colunas
    const colWidths = Object.keys(dados[0] || {}).map(key => ({
        wch: Math.max(key.length, 15)
    }));
    ws['!cols'] = colWidths;
    
    // Adicionar worksheet ao workbook
    XLSX.utils.book_append_sheet(wb, ws, nomeAba);
    
    // Salvar arquivo
    XLSX.writeFile(wb, nomeArquivo);
}

        function exportarTarefas() {
            const csv = [
                ['T√≠tulo', 'Monitor', 'Descri√ß√£o', 'Prazo', 'Urg√™ncia', 'Status'].join(','),
                ...tarefas.map(t => {
                    const monitor = monitores.find(m => m.id === t.monitorId);
                    return [
                        `"${t.titulo}"`,
                        `"${monitor?.nome || 'N/A'}"`,
                        `"${t.descricao}"`,
                        formatDate(t.prazo),
                        t.urgencia,
                        t.status
                    ].join(',');
                })
            ].join('\n');

            baixarCSV(csv, 'tarefas.csv');
        }

        function exportarAvaliacoes() {
            const csv = [
                ['Monitor', 'M√™s', 'Responsabilidade', 'Trabalho Coletivo', 'Iniciativa', 'Comunica√ß√£o', 'Projetos', 'Total', 'Medalhas'].join(','),
                ...avaliacoes.map(a => {
                    const monitor = monitores.find(m => m.id === a.monitorId);
                    const total = Object.values(a.rubricas || {}).reduce((sum, val) => sum + val, 0);
                    return [
                        `"${monitor?.nome || 'N/A'}"`,
                        a.mes,
                        a.rubricas?.Responsabilidade || 0,
                        a.rubricas?.TrabalhoColetivo || 0,
                        a.rubricas?.Iniciativa || 0,
                        a.rubricas?.Comunicacao || 0,
                        a.rubricas?.Projetos || 0,
                        total,
                        (a.medalhas || []).length
                    ].join(',');
                })
            ].join('\n');

            baixarCSV(csv, 'avaliacoes.csv');
        }

        function baixarCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Adicionar ao final das fun√ß√µes de admin config

async function limparAvaliacoesPorMes() {
    const mes = prompt('Digite o m√™s para excluir avalia√ß√µes (formato: YYYY-MM)\nExemplo: 2024-11');
    if (!mes) return;
    
    // Validar formato
    if (!/^\d{4}-\d{2}$/.test(mes)) {
        alert('Formato inv√°lido! Use YYYY-MM (exemplo: 2024-11)');
        return;
    }
    
    if (!confirm(`Tem certeza que deseja excluir TODAS as avalia√ß√µes de ${mes}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }
    
    try {
        const snapshot = await db.collection('avaliacoes')
            .where('mes', '==', mes)
            .get();
        
        if (snapshot.empty) {
            alert(`Nenhuma avalia√ß√£o encontrada para ${mes}`);
            return;
        }
        
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        await carregarAvaliacoes();
        atualizarConfigAdmin();
        
        alert(`${snapshot.size} avalia√ß√µes de ${mes} foram exclu√≠das!`);
    } catch (error) {
        console.error('Erro ao limpar avalia√ß√µes:', error);
        alert('Erro ao limpar avalia√ß√µes: ' + error.message);
    }
}

async function resetarAvaliacoesManterMedalhas() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√°:\n\n‚úì Excluir TODAS as avalia√ß√µes de TODOS os meses\n‚úì Manter as medalhas conquistadas\n‚úì Resetar pontua√ß√µes de avalia√ß√£o para 0\n\nContinuar?')) {
        return;
    }
    
    if (!confirm('Tem CERTEZA ABSOLUTA?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!')) {
        return;
    }
    
    try {
        // Excluir todas as avalia√ß√µes
        const snapshot = await db.collection('avaliacoes').get();
        const batch = db.batch();
        
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        console.log(`${snapshot.size} avalia√ß√µes exclu√≠das`);
        
        // Recarregar dados
        await carregarAvaliacoes();
        await carregarMonitores();
        atualizarConfigAdmin();
        
        alert(`Sistema resetado!\n\n‚úì ${snapshot.size} avalia√ß√µes exclu√≠das\n‚úì Medalhas mantidas\n‚úì Pontua√ß√µes de avalia√ß√£o zeradas`);
    } catch (error) {
        console.error('Erro ao resetar:', error);
        alert('Erro ao resetar sistema: ' + error.message);
    }
}

async function excluirTudoCompleto() {
    if (!confirm('üö® PERIGO: Esta a√ß√£o ir√° APAGAR TUDO:\n\n‚ùå Todas as avalia√ß√µes\n‚ùå Todas as tarefas\n‚ùå Todas as medalhas\n‚ùå Todas as pontua√ß√µes\n\n‚ö†Ô∏è TODOS OS DADOS SER√ÉO PERDIDOS!\n\nContinuar?')) {
        return;
    }
    
    const confirmacao = prompt('Digite "APAGAR TUDO" (em mai√∫sculas) para confirmar:');
    if (confirmacao !== 'APAGAR TUDO') {
        alert('Opera√ß√£o cancelada.');
        return;
    }
    
    try {
        let total = 0;
        
        // Excluir avalia√ß√µes
        const avalSnapshot = await db.collection('avaliacoes').get();
        const avalBatch = db.batch();
        avalSnapshot.docs.forEach(doc => avalBatch.delete(doc.ref));
        await avalBatch.commit();
        total += avalSnapshot.size;
        
        // Excluir tarefas
        const tarefaSnapshot = await db.collection('tarefas').get();
        const tarefaBatch = db.batch();
        tarefaSnapshot.docs.forEach(doc => tarefaBatch.delete(doc.ref));
        await tarefaBatch.commit();
        total += tarefaSnapshot.size;
        
        // Resetar monitores (manter cadastro, zerar pontos e medalhas)
        const monitoresAtivos = monitores.filter(m => m.tipo !== 'admin');
        const monitorBatch = db.batch();
        monitoresAtivos.forEach(m => {
            const ref = db.collection('monitores').doc(m.id);
            monitorBatch.update(ref, {
                pontuacao: 0,
                medalhas: []
            });
        });
        await monitorBatch.commit();
        
        await carregarTodosDados();
        atualizarInterface();
        
        alert(`Sistema completamente limpo!\n\n‚úì ${total} documentos exclu√≠dos\n‚úì ${monitoresAtivos.length} monitores resetados`);
    } catch (error) {
        console.error('Erro ao limpar tudo:', error);
        alert('Erro ao limpar sistema: ' + error.message);
    }
}
    </script>

    <!-- Biblioteca SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</body>
</html>
